<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Totally Rad Beauty | Clinic Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs (Ready for later connection) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // =========================================================================
        // APP STATE & SIMULATION DATA
        // =========================================================================
        
        const SERVICES = [
            "3D Skin Analysis + Custom Facial", "Dermaplaning", "MesoWhite BB Glow", "Superjection",
            "12-Step Ultimate Facial", "Radio Frequency (RF) Facial & Body", "Exosome Regeneration Therapy",
            "Picosecond Laser Skin Revitalisation", "Thermage CPT", "Cosmelan", "Cosmetic Skin Growth Removal",
            "SQT Bio-Microneedling", "HIFU", "Hydrodermabrasion and Microdermabrasion", "Microneedling",
            "Medi-Aesthetic Peel / Light Chemical Peel", "LED Light Therapy", "Oxygeneo",
            "Calming (High Frequency) Facial", "Fractional RF Microneedling", "Sonophoresis Vitamin Infusion",
            "Diode Laser Hair Removal", "Lash Lift", "Thermage CPT Body", "Cryolipolysis (Fat Freezing)",
            "HIFU Body", "Bacial", "Vacuum Therapy", "EMSculpt", "Cosmetic Skin Growth Removal Body",
            "Laser Lipolysis", "Hand Rejuvenation", "Ultrasonic Fat Cavitation", "Laser Skin Brightening", "Consultation"
        ];

        const defaultUsers = [
            { email: 'info@totallyradbeauty.com', role: 'admin', hourlyRate: 35, agreedHours: 40, name: 'Arianne' },
            { email: 'Rizkiastagini@gmail.com', role: 'therapist', hourlyRate: 25, agreedHours: 40, name: 'Rizki' },
            { email: 'ireneaat.ie@gmail.com', role: 'therapist', hourlyRate: 30, agreedHours: 35, name: 'Irene' },
            { email: 'totallyradbeautyph@gmail.com', role: 'therapist', hourlyRate: 20, agreedHours: 30, name: 'Abie' }
        ];

        let appState = {
            user: defaultUsers[0],
            isDemo: true, 
            users: defaultUsers,
            records: [],
            clients: [],
            sidebarOpen: false,
            currentDate: new Date()
        };

        // =========================================================================
        // CORE LOGIC
        // =========================================================================

        const Logic = {
            switchUser: (email) => {
                const user = appState.users.find(u => u.email === email);
                if (user) {
                    appState.user = user;
                    UI.renderDashboard();
                    UI.showToast(`Switched view to ${user.name}`);
                }
            },

            changeMonth: (offset) => {
                const newDate = new Date(appState.currentDate);
                newDate.setMonth(newDate.getMonth() + offset);
                appState.currentDate = newDate;
                UI.refreshStats();
                if(window.currentTab === 'history') UI.renderHistoryTable();
                if(window.currentTab === 'group') UI.renderGroupStats();
            },

            updateRecord: (id, updatedData) => {
                const index = appState.records.findIndex(r => r.id === id);
                if (index !== -1) {
                    appState.records[index] = {
                        ...appState.records[index],
                        ...updatedData,
                        totalAmount: (parseFloat(updatedData.serviceAmount) || 0) + (parseFloat(updatedData.productAmount) || 0)
                    };
                    if (updatedData.clientName && !appState.clients.includes(updatedData.clientName)) {
                        appState.clients.push(updatedData.clientName);
                        appState.clients.sort();
                    }
                    UI.refreshStats();
                    if(window.currentTab === 'dashboard') UI.renderTodayTable();
                    if(window.currentTab === 'history') UI.renderHistoryTable();
                    if(window.currentTab === 'group') UI.renderGroupStats();
                    UI.showToast("Record updated successfully!");
                    UI.closeEditModal();
                }
            },

            addRecord: (clientName, service, serviceAmount, productAmount, duration, entryType, isNew, isRebook) => {
                if (clientName && !appState.clients.includes(clientName)) {
                    appState.clients.push(clientName);
                    appState.clients.sort();
                }
                const record = {
                    id: Date.now(),
                    therapistEmail: appState.user.email,
                    clientName,
                    service: entryType === 'product' ? 'Product Sale' : service,
                    serviceAmount: parseFloat(serviceAmount || 0),
                    productAmount: parseFloat(productAmount || 0),
                    totalAmount: parseFloat(serviceAmount || 0) + parseFloat(productAmount || 0),
                    duration: entryType === 'product' ? null : duration,
                    entryType,
                    isNew,
                    isRebook,
                    date: new Date().toISOString()
                };
                appState.records.push(record);
                UI.refreshStats();
                if(window.currentTab === 'dashboard') UI.renderTodayTable();
                UI.showToast("Record added successfully!");
                UI.closeEntryModal();
            },

            getMetrics: (filterEmail = null, dateContext = new Date()) => {
                const emailToUse = filterEmail || appState.user.email;
                let filteredRecords = appState.records.filter(r => r.therapistEmail === emailToUse);
                let currentUserConfig = appState.users.find(u => u.email === emailToUse) || appState.user;

                const targetMonth = dateContext.getMonth();
                const targetYear = dateContext.getFullYear();
                filteredRecords = filteredRecords.filter(r => {
                    const rDate = new Date(r.date);
                    return rDate.getMonth() === targetMonth && rDate.getFullYear() === targetYear;
                });

                const totalRevenue = filteredRecords.reduce((sum, r) => sum + r.totalAmount, 0);
                const serviceRevenue = filteredRecords.reduce((sum, r) => sum + (r.serviceAmount || 0), 0);
                const productRevenue = filteredRecords.reduce((sum, r) => sum + (r.productAmount || 0), 0);
                const monthlyTarget = (currentUserConfig.hourlyRate * currentUserConfig.agreedHours) * 4;
                const percentageToTarget = monthlyTarget > 0 ? (totalRevenue / monthlyTarget) * 100 : 0;
                const totalClients = filteredRecords.length;
                const rebookedClients = filteredRecords.filter(r => r.isRebook).length;
                const rebookingRate = totalClients > 0 ? (rebookedClients / totalClients) * 100 : 0;

                return { totalRevenue, serviceRevenue, productRevenue, monthlyTarget, percentageToTarget, rebookingRate, totalClients, rebookedClients };
            },

            getGroupMetrics: (dateContext = new Date()) => {
                const targetMonth = dateContext.getMonth();
                const targetYear = dateContext.getFullYear();
                const filteredRecords = appState.records.filter(r => {
                    const rDate = new Date(r.date);
                    return rDate.getMonth() === targetMonth && rDate.getFullYear() === targetYear;
                });
                const totalRevenue = filteredRecords.reduce((sum, r) => sum + r.totalAmount, 0);
                const serviceRevenue = filteredRecords.reduce((sum, r) => sum + (r.serviceAmount || 0), 0);
                const productRevenue = filteredRecords.reduce((sum, r) => sum + (r.productAmount || 0), 0);
                const totalGroupTarget = appState.users.reduce((sum, u) => sum + ((u.hourlyRate * u.agreedHours) * 4), 0);
                const individualStats = appState.users.map(user => {
                    const userRecords = filteredRecords.filter(r => r.therapistEmail === user.email);
                    const userTotalRev = userRecords.reduce((sum, r) => sum + r.totalAmount, 0);
                    const userTarget = (user.hourlyRate * user.agreedHours) * 4;
                    const userClients = userRecords.length;
                    const userRebooked = userRecords.filter(r => r.isRebook).length;
                    return {
                        name: user.name, revenue: userTotalRev, serviceRevenue: userRecords.reduce((sum, r) => sum + (r.serviceAmount || 0), 0),
                        productRevenue: userRecords.reduce((sum, r) => sum + (r.productAmount || 0), 0),
                        targetPct: userTarget > 0 ? (userTotalRev / userTarget) * 100 : 0,
                        clients: userClients, rebooked: userRebooked,
                        rebookRate: userClients > 0 ? (userRebooked / userClients) * 100 : 0
                    };
                });
                return { totalRevenue, serviceRevenue, productRevenue, monthlyTarget: totalGroupTarget, percentageToTarget: totalGroupTarget > 0 ? (totalRevenue / totalGroupTarget) * 100 : 0, rebookingRate: filteredRecords.length > 0 ? (filteredRecords.filter(r => r.isRebook).length / filteredRecords.length) * 100 : 0, totalClients: filteredRecords.length, rebookedClients: filteredRecords.filter(r => r.isRebook).length, individualStats };
            },

            generateFakeData: () => {
                const newRecords = [];
                const durations = ["30m", "45m", "1h", "1h 30m", "2h"];
                const fakeClients = ["Alice Smith", "Bob Jones", "Charlie Day", "Diana Prince", "Evan Wright"];
                fakeClients.forEach(c => { if (!appState.clients.includes(c)) appState.clients.push(c); });
                const now = new Date();
                const lastMonth = new Date(); lastMonth.setMonth(lastMonth.getMonth() - 1);
                for(let i=0; i<30; i++) {
                    const randomUser = appState.users[Math.floor(Math.random() * appState.users.length)];
                    const isCurrentMonth = Math.random() > 0.5;
                    const dateBase = isCurrentMonth ? now : lastMonth;
                    const day = Math.floor(Math.random() * 28) + 1;
                    const recordDate = new Date(dateBase.getFullYear(), dateBase.getMonth(), day);
                    newRecords.push({
                        id: Date.now() + i, therapistEmail: randomUser.email, clientName: fakeClients[Math.floor(Math.random() * fakeClients.length)],
                        service: SERVICES[Math.floor(Math.random() * SERVICES.length)],
                        serviceAmount: Math.floor(Math.random() * 150) + 50,
                        productAmount: Math.random() > 0.8 ? Math.floor(Math.random() * 50) + 10 : 0,
                        totalAmount: 0, duration: durations[Math.floor(Math.random() * durations.length)],
                        entryType: 'service', isNew: Math.random() > 0.5, isRebook: Math.random() > 0.6, date: recordDate.toISOString()
                    });
                    newRecords[i].totalAmount = newRecords[i].serviceAmount + newRecords[i].productAmount;
                }
                appState.records = [...appState.records, ...newRecords];
                UI.refreshStats();
                if(window.currentTab === 'dashboard') UI.renderTodayTable();
                if(window.currentTab === 'history') UI.renderHistoryTable();
                if(window.currentTab === 'group') UI.renderGroupStats();
                UI.showToast("Generated 30 fake records.");
            }
        };

        // =========================================================================
        // UI HELPERS
        // =========================================================================

        const UI = {
            init: () => { UI.renderDashboard(); },
            toggleSidebar: () => {
                appState.sidebarOpen = !appState.sidebarOpen;
                document.getElementById('sidebar').classList.toggle('-translate-x-full', !appState.sidebarOpen);
                document.getElementById('sidebar-overlay').classList.toggle('hidden', !appState.sidebarOpen);
            },
            toggleEntryFields: () => {
                const entryType = document.querySelector('input[name="entryType"]:checked').value;
                document.getElementById('serviceFields').classList.toggle('hidden', entryType === 'product');
                document.getElementById('durationFields').classList.toggle('hidden', entryType === 'product');
                document.getElementById('productFields').classList.toggle('hidden', entryType === 'service');
            },
            toggleEditEntryFields: () => {
                const entryType = document.querySelector('input[name="editEntryType"]:checked').value;
                document.getElementById('editServiceFields').classList.toggle('hidden', entryType === 'product');
                document.getElementById('editDurationFields').classList.toggle('hidden', entryType === 'product');
                document.getElementById('editProductFields').classList.toggle('hidden', entryType === 'service');
            },
            openEntryModal: () => {
                document.getElementById('entryModal').classList.remove('hidden');
            },
            closeEntryModal: () => {
                document.getElementById('entryModal').classList.add('hidden');
                document.getElementById('dataEntryForm').reset();
                UI.toggleEntryFields();
            },
            openEditModal: (id) => {
                const r = appState.records.find(rec => rec.id === id);
                if (!r) return;
                const form = document.getElementById('editForm');
                form.dataset.id = id;
                form.querySelectorAll('input[name="editEntryType"]').forEach(radio => { if(radio.value === r.entryType) radio.checked = true; });
                UI.toggleEditEntryFields();
                form.editClientName.value = r.clientName || '';
                form.editService.value = r.service === 'Product Sale' ? '' : r.service;
                form.editAmount.value = r.serviceAmount || 0;
                form.editProductAmount.value = r.productAmount || 0;
                form.editDate.value = new Date(r.date).toISOString().split('T')[0];
                form.editIsNew.checked = r.isNew;
                form.editIsRebook.checked = r.isRebook;
                let h = 0, m = 0;
                if (r.duration) {
                    const hm = r.duration.match(/(\d+)h/); const mm = r.duration.match(/(\d+)m/);
                    if (hm) h = parseInt(hm[1]); if (mm) m = parseInt(mm[1]);
                }
                form.editDurationHours.value = h; form.editDurationMinutes.value = m;
                document.getElementById('editModal').classList.remove('hidden');
            },
            closeEditModal: () => { document.getElementById('editModal').classList.add('hidden'); },
            showToast: (m, t = 'success') => {
                const toast = document.createElement('div');
                toast.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg text-white z-50 transform transition-all duration-300 translate-y-10 opacity-0 ${t === 'error' ? 'bg-red-500' : 'bg-teal-600'}`;
                toast.textContent = m; document.body.appendChild(toast);
                setTimeout(() => toast.classList.remove('translate-y-10', 'opacity-0'), 10);
                setTimeout(() => { toast.classList.add('translate-y-10', 'opacity-0'); setTimeout(() => toast.remove(), 300); }, 3000);
            },
            calculateRowTarget: (input) => {
                const row = input.closest('tr');
                const rate = parseFloat(row.querySelector('.input-rate').value) || 0;
                const hours = parseFloat(row.querySelector('.input-hours').value) || 0;
                row.querySelector('.target-cell').textContent = '$' + ((rate * hours) * 4).toLocaleString();
            },

            renderDashboard: () => {
                const isAdmin = appState.user.role === 'admin';
                document.body.innerHTML = `
                    <div class="min-h-screen bg-gray-50 flex font-inter overflow-hidden relative">
                        <!-- NEW ENTRY MODAL -->
                        <div id="entryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                            <div class="bg-white rounded-xl shadow-xl w-full max-w-md overflow-y-auto max-h-[90vh]">
                                <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                                    <h3 class="text-sm font-bold text-gray-900 uppercase tracking-wider">New Performance Entry</h3>
                                    <button onclick="UI.closeEntryModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                                </div>
                                <form id="dataEntryForm" class="p-6 space-y-4">
                                    <div class="flex flex-wrap gap-4 mb-2 pb-2 border-b border-gray-50">
                                        <label class="flex items-center cursor-pointer"><input type="radio" name="entryType" value="service" checked onchange="UI.toggleEntryFields()"> <span class="ml-2 text-xs">Service Only</span></label>
                                        <label class="flex items-center cursor-pointer"><input type="radio" name="entryType" value="service_product" onchange="UI.toggleEntryFields()"> <span class="ml-2 text-xs">With Product/s</span></label>
                                        <label class="flex items-center cursor-pointer"><input type="radio" name="entryType" value="product" onchange="UI.toggleEntryFields()"> <span class="ml-2 text-xs">Product Only</span></label>
                                    </div>
                                    <div>
                                        <label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Client Name</label>
                                        <input type="text" name="clientName" list="clientOptions" required class="w-full rounded border p-2 text-xs shadow-sm focus:ring-1 focus:ring-teal-500 outline-none">
                                        <datalist id="clientOptions">${appState.clients.map(c => `<option value="${c}">`).join('')}</datalist>
                                    </div>
                                    <div id="serviceFields" class="space-y-4">
                                        <div>
                                            <label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Service Name</label>
                                            <select name="service" class="w-full rounded border p-2 text-xs shadow-sm focus:ring-1 focus:ring-teal-500 outline-none">${SERVICES.map(s => `<option value="${s}">${s}</option>`).join('')}</select>
                                        </div>
                                        <div>
                                            <label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Service Amount ($)</label>
                                            <input type="number" name="amount" step="0.01" class="w-full rounded border p-2 text-xs shadow-sm focus:ring-1 focus:ring-teal-500 outline-none" placeholder="0.00">
                                        </div>
                                    </div>
                                    <div id="productFields" class="hidden">
                                        <label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Product Amount ($)</label>
                                        <input type="number" name="productAmount" step="0.01" class="w-full rounded border p-2 text-xs bg-blue-50 shadow-sm focus:ring-1 focus:ring-teal-500 outline-none" placeholder="0.00">
                                    </div>
                                    <div id="durationFields">
                                        <label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Duration</label>
                                        <div class="flex space-x-2">
                                            <select name="durationHours" class="w-1/2 rounded border p-2 text-xs"><option value="0">0 hrs</option><option value="1" selected>1 hr</option><option value="2">2 hrs</option></select>
                                            <select name="durationMinutes" class="w-1/2 rounded border p-2 text-xs"><option value="0">0 mins</option><option value="15">15 mins</option><option value="30">30 mins</option><option value="45">45 mins</option></select>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-4 pt-2">
                                        <label class="flex items-center"><input type="checkbox" name="isNew" class="h-4 w-4 text-teal-600"> <span class="ml-2 text-xs">New Client?</span></label>
                                        <label class="flex items-center"><input type="checkbox" name="isRebook" class="h-4 w-4 text-teal-600"> <span class="ml-2 text-xs">Did Rebook?</span></label>
                                    </div>
                                    <div class="pt-4 flex flex-col space-y-2">
                                        <button type="submit" class="w-full py-3 bg-teal-600 text-white rounded text-xs font-bold uppercase tracking-wider hover:bg-teal-700 transition-colors shadow-md">Confirm & Add Entry</button>
                                        <button type="button" onclick="UI.closeEntryModal()" class="w-full py-2 bg-gray-50 text-gray-500 rounded text-xs font-medium hover:bg-gray-100 transition-colors">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- EDIT MODAL -->
                        <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                            <div class="bg-white rounded-xl shadow-xl w-full max-w-md overflow-y-auto max-h-[90vh]">
                                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                                    <h3 class="text-sm font-bold text-gray-900 uppercase tracking-wider">Update Record</h3>
                                    <button onclick="UI.closeEditModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                                </div>
                                <form id="editForm" class="p-6 space-y-4">
                                    <div class="flex flex-wrap gap-4 mb-4 pb-4 border-b border-gray-100">
                                        <label class="flex items-center cursor-pointer"><input type="radio" name="editEntryType" value="service" onchange="UI.toggleEditEntryFields()" class="h-4 w-4 text-teal-600"> <span class="ml-2 text-xs">Service Only</span></label>
                                        <label class="flex items-center cursor-pointer"><input type="radio" name="editEntryType" value="service_product" onchange="UI.toggleEditEntryFields()" class="h-4 w-4 text-teal-600"> <span class="ml-2 text-xs">With Product/s</span></label>
                                        <label class="flex items-center cursor-pointer"><input type="radio" name="editEntryType" value="product" onchange="UI.toggleEditEntryFields()" class="h-4 w-4 text-teal-600"> <span class="ml-2 text-xs">Product Only</span></label>
                                    </div>
                                    <div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Date</label><input type="date" name="editDate" required class="w-full rounded border p-2 text-xs"></div>
                                    <div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Client Name</label><input type="text" name="editClientName" list="clientOptions" required class="w-full rounded border p-2 text-xs"></div>
                                    <div id="editServiceFields" class="space-y-4">
                                        <div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Service Name</label><select name="editService" class="w-full rounded border p-2 text-xs">${SERVICES.map(s => `<option value="${s}">${s}</option>`).join('')}</select></div>
                                        <div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Service Amount ($)</label><input type="number" name="editAmount" step="0.01" class="w-full rounded border p-2 text-xs"></div>
                                    </div>
                                    <div id="editProductFields" class="hidden"><div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Product Amount ($)</label><input type="number" name="editProductAmount" step="0.01" class="w-full rounded border p-2 text-xs bg-blue-50"></div></div>
                                    <div id="editDurationFields"><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Duration</label><div class="flex space-x-2"><select name="editDurationHours" class="w-1/2 rounded border p-2 text-xs"><option value="0">0 hrs</option><option value="1">1 hr</option><option value="2">2 hrs</option></select><select name="editDurationMinutes" class="w-1/2 rounded border p-2 text-xs"><option value="0">0 mins</option><option value="15">15 mins</option><option value="30">30 mins</option><option value="45">45 mins</option></select></div></div>
                                    <div class="flex items-center space-x-4 pt-2"><label class="flex items-center"><input type="checkbox" name="editIsNew" class="h-4 w-4"> <span class="ml-2 text-xs">New Client?</span></label><label class="flex items-center"><input type="checkbox" name="editIsRebook" class="h-4 w-4"> <span class="ml-2 text-xs">Did Rebook?</span></label></div>
                                    <div class="pt-4 flex justify-end space-x-3"><button type="button" onclick="UI.closeEditModal()" class="px-4 py-2 text-xs bg-gray-100 rounded">Cancel</button><button type="submit" class="px-4 py-2 text-xs bg-black text-white rounded">Save Changes</button></div>
                                </form>
                            </div>
                        </div>

                        <!-- Mobile Header -->
                        <div class="md:hidden fixed top-0 w-full bg-black text-white z-20 flex items-center justify-between px-4 py-3"><h1 class="text-lg font-bold">TRB<span class="text-teal-400">.</span></h1><button onclick="UI.toggleSidebar()" class="text-gray-300"><i class="fas fa-bars"></i></button></div>
                        
                        <!-- Sidebar -->
                        <div id="sidebar" class="fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 bg-black text-white w-64 z-30 flex flex-col pt-16 md:pt-0">
                            <div class="hidden md:block p-6 border-b border-gray-800"><h1 class="text-xl font-bold tracking-wider">TRB<span class="text-teal-400">.</span></h1><p class="text-xs text-gray-400 mt-1 uppercase tracking-tighter">${appState.user.name}</p></div>
                            <nav class="p-4 space-y-2 flex-1">
                                <button onclick="UI.switchTab('dashboard');" id="nav-dashboard" class="w-full text-left px-4 py-3 rounded-lg bg-gray-900 text-teal-400 font-medium transition-colors">Dashboard</button>
                                <button onclick="UI.switchTab('history');" id="nav-history" class="w-full text-left px-4 py-3 rounded-lg text-gray-400 transition-colors">History</button>
                                <button onclick="UI.switchTab('group');" id="nav-group" class="w-full text-left px-4 py-3 rounded-lg text-gray-400 transition-colors">Group</button>
                                ${isAdmin ? `<button onclick="UI.switchTab('config');" id="nav-config" class="w-full text-left px-4 py-3 rounded-lg text-gray-400 transition-colors">Configuration</button>` : ''}
                            </nav>
                            <div class="p-4 border-t border-gray-800"><label class="block text-[10px] text-gray-500 mb-2 uppercase font-bold tracking-widest">Switch Profile</label><select onchange="Logic.switchUser(this.value)" class="w-full bg-gray-900 text-gray-300 text-xs rounded p-2 border border-gray-700">${appState.users.map(u => `<option value="${u.email}" ${appState.user.email === u.email ? 'selected' : ''}>${u.name}</option>`).join('')}</select></div>
                        </div>

                        <div onclick="UI.toggleSidebar()" class="md:hidden fixed inset-0 bg-black bg-opacity-50 z-10 hidden" id="sidebar-overlay"></div>
                        
                        <div class="flex-1 overflow-y-auto h-screen pt-14 md:pt-0 w-full">
                            <header class="bg-white shadow-sm sticky top-0 z-10">
                                <div class="px-6 py-4 flex justify-between items-center">
                                    <h2 class="text-lg font-semibold text-gray-800" id="page-title">My Performance</h2>
                                    <div class="flex space-x-2">
                                        <button onclick="Logic.generateFakeData()" class="text-[10px] font-bold uppercase bg-gray-50 px-3 py-1 rounded border hover:bg-gray-100 transition-colors">Seed Data</button>
                                        <button onclick="UI.openEntryModal()" class="text-[10px] font-bold uppercase bg-teal-600 text-white px-4 py-1.5 rounded shadow hover:bg-teal-700 transition-colors">+ Add New Entry</button>
                                    </div>
                                </div>
                            </header>
                            <main class="p-4 md:p-8" id="main-content"></main>
                        </div>
                    </div>
                `;
                
                // Set up submission logic for new entry
                document.getElementById('dataEntryForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    const entryType = fd.get('entryType');
                    const sa = parseFloat(fd.get('amount') || 0);
                    const pa = parseFloat(fd.get('productAmount') || 0);
                    const h = parseInt(fd.get('durationHours') || 0);
                    const m = parseInt(fd.get('durationMinutes') || 0);
                    if (entryType !== 'product' && h === 0 && m === 0) { UI.showToast("Please select a valid duration.", "error"); return; }
                    if ((entryType === 'product' || entryType === 'service_product') && pa <= 0) { UI.showToast("Enter valid product amount.", "error"); return; }
                    let d = ""; if (h > 0) d += `${h}h `; if (m > 0 || h == 0) d += `${m}m`;
                    Logic.addRecord(fd.get('clientName'), fd.get('service'), sa, pa, d.trim(), entryType, fd.get('isNew') === 'on', fd.get('isRebook') === 'on');
                });

                // Set up submission logic for edit form
                document.getElementById('editForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    const id = parseInt(e.target.dataset.id);
                    const entryType = fd.get('editEntryType');
                    const sa = parseFloat(fd.get('editAmount') || 0);
                    const pa = parseFloat(fd.get('editProductAmount') || 0);
                    const h = parseInt(fd.get('editDurationHours') || 0);
                    const m = parseInt(fd.get('editDurationMinutes') || 0);
                    if (entryType !== 'product' && h === 0 && m === 0) { UI.showToast("Please select a valid duration.", "error"); return; }
                    if ((entryType === 'product' || entryType === 'service_product') && pa <= 0) { UI.showToast("Enter valid product amount.", "error"); return; }
                    let d = ""; if (h > 0) d += `${h}h `; if (m > 0 || h == 0) d += `${m}m`;
                    const updatedData = {
                        date: new Date(fd.get('editDate')).toISOString(),
                        clientName: fd.get('editClientName'),
                        service: entryType === 'product' ? 'Product Sale' : fd.get('editService'),
                        serviceAmount: sa, productAmount: pa,
                        duration: entryType === 'product' ? null : d.trim(),
                        entryType,
                        isNew: fd.get('editIsNew') === 'on',
                        isRebook: fd.get('editIsRebook') === 'on'
                    };
                    Logic.updateRecord(id, updatedData);
                });

                UI.switchTab('dashboard');
            },

            switchTab: (tabName) => {
                window.currentTab = tabName;
                document.querySelectorAll('nav button').forEach(b => {
                    b.classList.toggle('bg-gray-900', b.id === `nav-${tabName}`);
                    b.classList.toggle('text-teal-400', b.id === `nav-${tabName}`);
                });
                const main = document.getElementById('main-content');
                if (tabName === 'dashboard') {
                    document.getElementById('page-title').textContent = 'My Performance';
                    main.innerHTML = `
                        <div id="stats-container"></div>
                        <div class="bg-white rounded-xl border p-6 flex flex-col shadow-sm">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-sm font-bold text-gray-900">Today's Activity</h3>
                                <button onclick="UI.openEntryModal()" class="text-[10px] font-bold text-teal-600 hover:text-teal-700 uppercase">+ Add Record</button>
                            </div>
                            <div class="flex-1 overflow-x-auto">
                                <table class="min-w-full divide-y">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-2 py-2 text-left text-[10px] font-bold text-gray-400 uppercase">Date</th>
                                            <th class="px-2 py-2 text-left text-[10px] font-bold text-gray-400 uppercase">Client</th>
                                            <th class="px-2 py-2 text-left text-[10px] font-bold text-gray-400 uppercase">Service/Item</th>
                                            <th class="px-2 py-2 text-right text-[10px] font-bold text-gray-400 uppercase">Total</th>
                                            <th class="px-2 py-2 text-center text-[10px] font-bold text-gray-400 uppercase">Details</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-table-body" class="divide-y"></tbody>
                                </table>
                            </div>
                        </div>`;
                    UI.refreshStats(); UI.renderTodayTable();
                } else if (tabName === 'history') {
                    document.getElementById('page-title').textContent = 'History';
                    main.innerHTML = `<div class="bg-white rounded-xl border p-6 flex flex-col shadow-sm"><div class="flex justify-between items-center mb-6"><h3 class="text-sm font-bold text-gray-900">Monthly Records</h3><div class="flex items-center space-x-1 bg-gray-50 rounded p-0.5 border"><button onclick="Logic.changeMonth(-1)" class="p-1 hover:bg-white rounded"><i class="fas fa-chevron-left text-[10px]"></i></button><span class="text-[10px] font-bold w-24 text-center select-none uppercase" id="history-month-display"></span><button onclick="Logic.changeMonth(1)" class="p-1 hover:bg-white rounded"><i class="fas fa-chevron-right text-[10px]"></i></button></div></div><div class="overflow-x-auto"><table class="min-w-full divide-y"><thead class="bg-gray-50"><tr><th class="px-2 py-2 text-left text-[10px] font-bold text-gray-400 uppercase">Date</th><th class="px-2 py-2 text-left text-[10px] font-bold text-gray-400 uppercase">Client</th><th class="px-2 py-2 text-left text-[10px] font-bold text-gray-400 uppercase">Service/Item</th><th class="px-2 py-2 text-right text-[10px] font-bold text-gray-400 uppercase">Total</th><th class="px-2 py-2 text-center text-[10px] font-bold text-gray-400 uppercase">Details</th></tr></thead><tbody id="history-table-body" class="divide-y"></tbody></table></div></div>`;
                    UI.renderHistoryTable();
                } else if (tabName === 'group') {
                    document.getElementById('page-title').textContent = 'Group Performance';
                    main.innerHTML = `<div id="group-stats-container"></div>`;
                    UI.renderGroupStats();
                } else if (tabName === 'config') {
                    document.getElementById('page-title').textContent = 'Configuration';
                    main.innerHTML = `<div class="bg-white rounded-xl border shadow-sm overflow-hidden"><div class="p-6 border-b flex justify-between items-center"><h3 class="text-sm font-bold">User Settings</h3><div class="flex space-x-2"><input type="email" id="newUserEmail" placeholder="New user email" class="border rounded p-2 text-xs"><button onclick="UI.handleAddUser()" class="bg-gray-200 px-3 rounded text-xs">Add</button><button onclick="Logic.saveAllConfigs()" class="bg-teal-600 text-white px-4 py-2 rounded text-xs shadow-sm font-bold">Save All</button></div></div><table class="min-w-full divide-y"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-[10px] font-bold text-gray-400 uppercase">Email</th><th class="px-4 py-3 text-left text-[10px] font-bold text-gray-400 uppercase">Display Name</th><th class="px-4 py-3 text-left text-[10px] font-bold text-gray-400 uppercase">Role</th><th class="px-4 py-3 text-left text-[10px] font-bold text-gray-400 uppercase">Hourly Rate</th><th class="px-4 py-3 text-left text-[10px] font-bold text-gray-400 uppercase">Weekly Hours</th><th class="px-4 py-3 text-left text-[10px] font-bold text-gray-400 uppercase">Monthly Target</th></tr></thead><tbody id="config-table-body" class="divide-y"></tbody></table></div>`;
                    UI.renderConfigTable();
                }
            },

            refreshStats: () => {
                if (window.currentTab !== 'dashboard') return;
                const m = Logic.getMetrics(appState.user.email, appState.currentDate);
                const cm = appState.currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                const mv = Math.max(m.totalRevenue, m.monthlyTarget, 1);
                const ah = Math.min((m.totalRevenue / mv) * 100, 100);
                const th = Math.min((m.monthlyTarget / mv) * 100, 100);
                document.getElementById('stats-container').innerHTML = `
                    <div class="bg-white p-4 rounded-xl border mb-4 shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">My Progress</h3>
                            <div class="flex items-center space-x-1 bg-gray-50 rounded p-0.5 border">
                                <button onclick="Logic.changeMonth(-1)" class="p-1 hover:bg-white rounded"><i class="fas fa-chevron-left text-[10px]"></i></button>
                                <span class="text-[10px] font-bold w-24 text-center select-none uppercase">${cm}</span>
                                <button onclick="Logic.changeMonth(1)" class="p-1 hover:bg-white rounded"><i class="fas fa-chevron-right text-[10px]"></i></button>
                            </div>
                        </div>
                        <div class="flex justify-center items-end space-x-12 h-64 border-b border-gray-100 pb-2 mb-4">
                            <div class="flex flex-col items-center w-24 h-full justify-end">
                                <div class="text-[10px] font-bold text-teal-600 mb-2">$${m.totalRevenue.toLocaleString()}</div>
                                <div style="height: ${ah}%;" class="w-16 md:w-20 bg-teal-500 rounded-t-lg shadow-md transition-all duration-1000"></div>
                                <div class="mt-3 text-[10px] font-bold text-gray-400 uppercase tracking-tighter">Actual</div>
                            </div>
                            <div class="flex flex-col items-center w-24 h-full justify-end">
                                <div class="text-[10px] font-bold text-blue-600 mb-2">$${m.monthlyTarget.toLocaleString()}</div>
                                <div style="height: ${th}%;" class="w-16 md:w-20 bg-blue-100 border-t border-x border-blue-200 rounded-t-lg shadow-sm transition-all duration-1000"></div>
                                <div class="mt-3 text-[10px] font-bold text-gray-400 uppercase tracking-tighter">Target</div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
                        <div class="bg-white p-4 rounded-lg border-l-4 border-teal-500 shadow-sm"><p class="text-[10px] font-bold text-gray-400 uppercase">Revenue</p><p class="text-xl font-bold">$${m.totalRevenue.toLocaleString()}</p><p class="text-[10px] text-gray-500 truncate">Svc: $${m.serviceRevenue} | Prod: $${m.productRevenue}</p></div>
                        <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500 shadow-sm"><p class="text-[10px] font-bold text-gray-400 uppercase">Goal</p><p class="text-xl font-bold">$${m.monthlyTarget.toLocaleString()}</p></div>
                        <div class="bg-white p-4 rounded-lg border-l-4 ${m.percentageToTarget >= 100 ? 'border-green-500' : 'border-yellow-500'} shadow-sm"><p class="text-[10px] font-bold text-gray-400 uppercase">Status</p><div class="flex items-baseline"><p class="text-xl font-bold">${m.percentageToTarget.toFixed(1)}%</p>${m.percentageToTarget >= 100 ? '<span class="ml-2 text-green-600 text-[10px] font-bold uppercase">Hit!</span>' : ''}</div></div>
                        <div class="bg-white p-4 rounded-lg border-l-4 border-purple-500 shadow-sm"><p class="text-[10px] font-bold text-gray-400 uppercase">Rebooking</p><p class="text-xl font-bold">${m.rebookingRate.toFixed(1)}%</p><p class="text-[10px] text-gray-400">${m.rebookedClients}/${m.totalClients} Clients</p></div>
                    </div>`;
            },

            renderGroupStats: () => {
                const m = Logic.getGroupMetrics(appState.currentDate);
                const cm = appState.currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                const mv = Math.max(m.totalRevenue, m.monthlyTarget, 1);
                const ah = Math.min((m.totalRevenue / mv) * 100, 100);
                const th = Math.min((m.monthlyTarget / mv) * 100, 100);
                const cols = ['bg-teal-400', 'bg-sky-400', 'bg-violet-400', 'bg-rose-400', 'bg-amber-400'];
                const segs = m.individualStats.map((s, i) => s.revenue <= 0 ? '' : `<div style="height: ${(s.revenue / m.totalRevenue) * 100}%" class="w-full ${cols[i % cols.length]} border-b border-white/20 first:border-b-0" title="${s.name}: $${s.revenue}"></div>`).join('');
                const legs = m.individualStats.map((s, i) => `<div class="flex items-center text-[10px] text-gray-600"><span class="w-2.5 h-2.5 rounded-full ${cols[i % cols.length]} mr-1.5 shadow-sm"></span><span>${s.name}</span></div>`).join('');

                document.getElementById('group-stats-container').innerHTML = `
                    <div class="bg-white p-4 rounded-xl border mb-4 shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Team Progress</h3>
                            <div class="flex items-center space-x-1 bg-gray-50 rounded p-0.5 border">
                                <button onclick="Logic.changeMonth(-1)" class="p-1 hover:bg-white rounded"><i class="fas fa-chevron-left text-[10px]"></i></button>
                                <span class="text-[10px] font-bold w-24 text-center select-none uppercase">${cm}</span>
                                <button onclick="Logic.changeMonth(1)" class="p-1 hover:bg-white rounded"><i class="fas fa-chevron-right text-[10px]"></i></button>
                            </div>
                        </div>
                        <div class="flex justify-center items-end space-x-16 h-64 border-b border-gray-100 pb-2 mb-4">
                            <div class="flex flex-col items-center w-24 h-full justify-end">
                                <div class="text-[10px] font-bold text-teal-600 mb-2">$${m.totalRevenue.toLocaleString()}</div>
                                <div style="height: ${ah}%;" class="w-16 md:w-20 rounded-t-lg overflow-hidden flex flex-col-reverse shadow-md transition-all duration-1000">${segs}</div>
                                <div class="mt-3 text-[10px] font-bold text-gray-400 uppercase tracking-tighter">Actual</div>
                            </div>
                            <div class="flex flex-col items-center w-24 h-full justify-end">
                                <div class="text-[10px] font-bold text-blue-600 mb-2">$${m.monthlyTarget.toLocaleString()}</div>
                                <div style="height: ${th}%;" class="w-16 md:w-20 bg-blue-100 border-t border-x border-blue-200 rounded-t-lg shadow-sm transition-all duration-1000"></div>
                                <div class="mt-3 text-[10px] font-bold text-gray-400 uppercase tracking-tighter">Target</div>
                            </div>
                        </div>
                        <div class="flex flex-wrap justify-center gap-x-6 gap-y-2 mt-4 pt-4 border-t border-gray-50">${legs}</div>
                    </div>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
                        <div class="bg-white p-4 rounded-lg border-l-4 border-teal-500 shadow-sm"><p class="text-[10px] font-bold text-gray-400 uppercase">Team Rev</p><p class="text-xl font-bold">$${m.totalRevenue.toLocaleString()}</p><p class="text-[10px] text-gray-500 truncate">Svc: $${m.serviceRevenue} | Prod: $${m.productRevenue}</p></div>
                        <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500 shadow-sm"><p class="text-[10px] font-bold text-gray-400 uppercase">Team Target</p><p class="text-xl font-bold">$${m.monthlyTarget.toLocaleString()}</p></div>
                        <div class="bg-white p-4 rounded-lg border-l-4 ${m.percentageToTarget >= 100 ? 'border-green-500' : 'border-yellow-500'} shadow-sm"><p class="text-[10px] font-bold text-gray-400 uppercase">Status</p><p class="text-xl font-bold">${m.percentageToTarget.toFixed(1)}%</p></div>
                        <div class="bg-white p-4 rounded-lg border-l-4 border-purple-500 shadow-sm"><p class="text-[10px] font-bold text-gray-400 uppercase">Rebooking</p><p class="text-xl font-bold">${m.rebookingRate.toFixed(1)}%</p><p class="text-[10px] text-gray-400">${m.rebookedClients}/${m.totalClients} Clients</p></div>
                    </div>
                    <div class="bg-white rounded-xl border p-6 shadow-sm">
                        <h3 class="text-sm font-bold mb-4">Therapist Breakdown</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-2 py-2 text-left text-[10px] font-bold text-gray-400 uppercase">Therapist</th>
                                        <th class="px-2 py-2 text-right text-[10px] font-bold text-gray-400 uppercase">Total Rev</th>
                                        <th class="px-2 py-2 text-right text-[10px] font-bold text-gray-400 uppercase">Svc ($)</th>
                                        <th class="px-2 py-2 text-right text-[10px] font-bold text-gray-400 uppercase">Prod ($)</th>
                                        <th class="px-2 py-2 text-right text-[10px] font-bold text-gray-400 uppercase">Target %</th>
                                        <th class="px-2 py-2 text-right text-[10px] font-bold text-gray-400 uppercase">Rebook %</th>
                                        <th class="px-2 py-2 text-center text-[10px] font-bold text-gray-400 uppercase">Clients</th>
                                        <th class="px-2 py-2 text-center text-[10px] font-bold text-gray-400 uppercase">Rebooked</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">${m.individualStats.map(s => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-2 py-2 text-xs font-bold text-gray-900">${s.name}</td>
                                        <td class="px-2 py-2 text-xs text-right font-bold text-gray-900">$${s.revenue.toLocaleString()}</td>
                                        <td class="px-2 py-2 text-xs text-right text-gray-500">$${s.serviceRevenue}</td>
                                        <td class="px-2 py-2 text-xs text-right text-blue-600 font-medium">$${s.productRevenue}</td>
                                        <td class="px-2 py-2 text-xs text-right ${s.targetPct >= 100 ? 'text-green-600 font-bold' : 'text-gray-500'}">${s.targetPct.toFixed(1)}%</td>
                                        <td class="px-2 py-2 text-xs text-right font-bold text-gray-900">${s.rebookRate.toFixed(1)}%</td>
                                        <td class="px-2 py-2 text-xs text-center text-gray-500">${s.clients}</td>
                                        <td class="px-2 py-2 text-xs text-center text-gray-500">${s.rebooked}</td>
                                    </tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            },

            renderTodayTable: () => {
                const tbody = document.getElementById('recent-table-body'); if (!tbody) return;
                const today = new Date(); today.setHours(0,0,0,0);
                const records = appState.records.filter(r => {
                    const rDate = new Date(r.date); rDate.setHours(0,0,0,0);
                    return rDate.getTime() === today.getTime() && r.therapistEmail === appState.user.email;
                }).sort((a, b) => new Date(a.date) - new Date(b.date));
                if (records.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-400 italic text-xs">No activity found for your profile today.</td></tr>'; return; }
                tbody.innerHTML = records.map(r => {
                    const ds = new Date(r.date).toLocaleDateString([], { month: 'numeric', day: 'numeric' });
                    return `
                        <tr class="hover:bg-gray-50 border-b border-gray-100 last:border-0">
                            <td class="px-2 py-2 text-xs text-gray-500">${ds}</td>
                            <td class="px-2 py-2 text-xs font-bold truncate max-w-[100px] text-gray-900">${r.clientName || 'N/A'}</td>
                            <td class="px-2 py-2 text-xs text-gray-600 truncate max-w-[120px]">
                                <div class="font-medium">${r.service}</div>
                                ${r.duration ? `<span class="text-[10px] text-gray-400"><i class="far fa-clock mr-1"></i>${r.duration}</span>` : ''}
                                ${r.productAmount > 0 ? `<span class="text-[10px] text-blue-500 font-bold ml-1">+$${r.productAmount}P</span>` : ''}
                            </td>
                            <td class="px-2 py-2 text-xs text-right font-bold text-gray-900">$${r.totalAmount.toFixed(2)}</td>
                            <td class="px-2 py-2 text-center text-xs">
                                <div class="flex items-center justify-center space-x-1">
                                    ${r.isNew ? '<span class="px-1.5 py-0.5 bg-green-100 text-green-800 text-[10px] rounded leading-none">New</span>' : ''}
                                    ${r.isRebook ? '<span class="px-1.5 py-0.5 bg-purple-100 text-purple-800 text-[10px] rounded leading-none">Rebook</span>' : ''}
                                    <button onclick="UI.openEditModal(${r.id})" class="text-gray-400 hover:text-teal-600 p-1 transition-colors"><i class="fas fa-pencil-alt text-xs"></i></button>
                                </div>
                            </td>
                        </tr>`;
                }).join('');
            },

            renderHistoryTable: () => {
                const tbody = document.getElementById('history-table-body'); if (!tbody) return;
                const tm = appState.currentDate.getMonth(); const ty = appState.currentDate.getFullYear();
                document.getElementById('history-month-display').textContent = appState.currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                const records = appState.records.filter(r => {
                    const rDate = new Date(r.date);
                    return rDate.getMonth() === tm && rDate.getFullYear() === ty && r.therapistEmail === appState.user.email;
                }).sort((a, b) => new Date(a.date) - new Date(b.date));
                if (records.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-400 italic text-xs">No records found for your profile this month.</td></tr>'; return; }
                tbody.innerHTML = records.map(r => {
                    const ds = new Date(r.date).toLocaleDateString([], { month: 'numeric', day: 'numeric' });
                    return `
                        <tr class="hover:bg-gray-50 border-b border-gray-100 last:border-0">
                            <td class="px-2 py-2 text-xs text-gray-500">${ds}</td>
                            <td class="px-2 py-2 text-xs font-bold truncate max-w-[100px] text-gray-900">${r.clientName || 'N/A'}</td>
                            <td class="px-2 py-2 text-xs text-gray-600 truncate max-w-[120px]">
                                <div class="font-medium">${r.service}</div>
                                ${r.duration ? `<span class="text-[10px] text-gray-400"><i class="far fa-clock mr-1"></i>${r.duration}</span>` : ''}
                            </td>
                            <td class="px-2 py-2 text-xs text-right font-bold text-gray-900">$${r.totalAmount.toFixed(2)}</td>
                            <td class="px-2 py-2 text-center text-xs">
                                <div class="flex items-center justify-center space-x-1">
                                    ${r.isNew ? '<span class="px-1.5 py-0.5 bg-green-100 text-green-800 text-[10px] rounded leading-none">New</span>' : ''}
                                    ${r.isRebook ? '<span class="px-1.5 py-0.5 bg-purple-100 text-purple-800 text-[10px] rounded leading-none">Rebook</span>' : ''}
                                    <button onclick="UI.openEditModal(${r.id})" class="text-gray-400 hover:text-teal-600 p-1 transition-colors"><i class="fas fa-pencil-alt text-xs"></i></button>
                                </div>
                            </td>
                        </tr>`;
                }).join('');
            },

            renderConfigTable: () => {
                const tbody = document.getElementById('config-table-body'); if (!tbody) return;
                tbody.innerHTML = appState.users.map(u => `
                    <tr class="hover:bg-gray-50 config-row" data-email="${u.email}">
                        <td class="px-4 py-3 text-xs font-bold text-gray-600">${u.email}</td>
                        <td class="px-4 py-3"><input type="text" value="${u.name}" class="input-name w-32 border rounded p-1 text-xs focus:ring-1 focus:ring-teal-500 outline-none shadow-sm"></td>
                        <td class="px-4 py-3"><span class="px-2 py-0.5 text-[10px] font-bold rounded-full ${u.role === 'admin' ? 'bg-black text-white' : 'bg-gray-100 text-gray-600'} uppercase">${u.role}</span></td>
                        <td class="px-4 py-3"><input type="number" value="${u.hourlyRate}" oninput="UI.calculateRowTarget(this)" class="input-rate w-20 border rounded p-1 text-xs text-right focus:ring-1 focus:ring-teal-500 outline-none shadow-sm"></td>
                        <td class="px-4 py-3"><input type="number" value="${u.agreedHours}" oninput="UI.calculateRowTarget(this)" class="input-hours w-20 border rounded p-1 text-xs text-right focus:ring-1 focus:ring-teal-500 outline-none shadow-sm"></td>
                        <td class="px-4 py-3 text-xs font-bold text-gray-900 target-cell">$${((u.hourlyRate * u.agreedHours) * 4).toLocaleString()}</td>
                    </tr>
                `).join('');
            },

            handleAddUser: () => {
                const email = document.getElementById('newUserEmail').value;
                if (email && email.includes('@')) { Logic.addUser(email); document.getElementById('newUserEmail').value = ''; } else { UI.showToast("Invalid email", "error"); }
            }
        };

        window.UI = UI; window.Logic = Logic;
        window.addEventListener('DOMContentLoaded', UI.init);
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
    </style>
</head>
<body><div id="app"></div></body>
</html>