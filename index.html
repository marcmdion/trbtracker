<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Totally Rad Beauty | Clinic Dashboard v2.5</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // =========================================================================
        // APP CONSTANTS & VERSIONING
        // =========================================================================
        const APP_VERSION = "2.5.0";
        
        const SERVICES = [
            "3D Skin Analysis + Custom Facial", "Dermaplaning", "MesoWhite BB Glow", "Superjection",
            "12-Step Ultimate Facial", "Radio Frequency (RF) Facial & Body", "Exosome Regeneration Therapy",
            "Picosecond Laser Skin Revitalisation", "Thermage CPT", "Cosmelan", "Cosmetic Skin Growth Removal",
            "SQT Bio-Microneedling", "HIFU", "Hydrodermabrasion and Microdermabrasion", "Microneedling",
            "Medi-Aesthetic Peel / Light Chemical Peel", "LED Light Therapy", "Oxygeneo",
            "Calming (High Frequency) Facial", "Fractional RF Microneedling", "Sonophoresis Vitamin Infusion",
            "Diode Laser Hair Removal", "Lash Lift", "Thermage CPT Body", "Cryolipolysis (Fat Freezing)",
            "HIFU Body", "Bacial", "Vacuum Therapy", "EMSculpt", "Cosmetic Skin Growth Removal Body",
            "Laser Lipolysis", "Hand Rejuvenation", "Ultrasonic Fat Cavitation", "Laser Skin Brightening", "Consultation"
        ];

        const defaultUsers = [
            { email: 'info@totallyradbeauty.com', role: 'admin', hourlyRate: 35, agreedHours: 40, name: 'Arianne' },
            { email: 'Rizkiastagini@gmail.com', role: 'therapist', hourlyRate: 25, agreedHours: 40, name: 'Rizki' },
            { email: 'ireneaat.ie@gmail.com', role: 'therapist', hourlyRate: 30, agreedHours: 35, name: 'Irene' },
            { email: 'totallyradbeautyph@gmail.com', role: 'therapist', hourlyRate: 20, agreedHours: 30, name: 'Abie' }
        ];

        let appState = {
            user: defaultUsers[0],
            isDemo: true, 
            users: defaultUsers,
            records: [],
            clients: [],
            currentDate: new Date(),
            pendingDeleteId: null
        };

        // =========================================================================
        // CORE LOGIC
        // =========================================================================

        const Logic = {
            switchUser: (email) => {
                const user = appState.users.find(u => u.email === email);
                if (user) {
                    appState.user = user;
                    UI.renderDashboard();
                    UI.showToast(`Switched to ${user.name}`);
                }
            },

            changeMonth: (offset) => {
                const newDate = new Date(appState.currentDate);
                newDate.setMonth(newDate.getMonth() + offset);
                appState.currentDate = newDate;
                UI.refreshStats();
                if(window.currentTab === 'history') UI.renderHistoryTable();
                if(window.currentTab === 'group') UI.renderGroupStats();
            },

            addRecord: (clientName, service, serviceAmount, productAmount, duration, entryType, isNew, isRebook, date) => {
                if (clientName && !appState.clients.includes(clientName)) {
                    appState.clients.push(clientName);
                    appState.clients.sort();
                }
                const record = {
                    id: Date.now(),
                    therapistEmail: appState.user.email,
                    clientName,
                    service: entryType === 'product' ? 'Product Sale' : service,
                    serviceAmount: parseFloat(serviceAmount || 0),
                    productAmount: parseFloat(productAmount || 0),
                    totalAmount: parseFloat(serviceAmount || 0) + parseFloat(productAmount || 0),
                    duration: entryType === 'product' ? null : duration,
                    entryType,
                    isNew,
                    isRebook,
                    date: date ? new Date(date).toISOString() : new Date().toISOString()
                };
                appState.records.push(record);
                UI.refreshStats();
                if(window.currentTab === 'dashboard') UI.renderTodayTable();
                UI.showToast("Record added successfully!");
                UI.closeEntryModal();
            },

            updateRecord: (id, updatedData) => {
                const index = appState.records.findIndex(r => r.id === id);
                if (index !== -1) {
                    appState.records[index] = {
                        ...appState.records[index],
                        ...updatedData,
                        totalAmount: (parseFloat(updatedData.serviceAmount) || 0) + (parseFloat(updatedData.productAmount) || 0)
                    };
                    UI.refreshStats();
                    if(window.currentTab === 'dashboard') UI.renderTodayTable();
                    if(window.currentTab === 'history') UI.renderHistoryTable();
                    if(window.currentTab === 'group') UI.renderGroupStats();
                    UI.showToast("Record updated!");
                    UI.closeEditModal();
                }
            },

            deleteRecord: (id) => {
                const index = appState.records.findIndex(r => r.id === id);
                if (index !== -1) {
                    appState.records.splice(index, 1);
                    UI.refreshStats();
                    if(window.currentTab === 'dashboard') UI.renderTodayTable();
                    if(window.currentTab === 'history') UI.renderHistoryTable();
                    if(window.currentTab === 'group') UI.renderGroupStats();
                    UI.showToast("Record deleted", "error");
                    UI.closeDeleteModal();
                }
            },

            getMetrics: (filterEmail = null, dateContext = new Date()) => {
                const emailToUse = filterEmail || appState.user.email;
                let filteredRecords = appState.records.filter(r => r.therapistEmail === emailToUse);
                let currentUserConfig = appState.users.find(u => u.email === emailToUse) || appState.user;
                const tm = dateContext.getMonth(); const ty = dateContext.getFullYear();
                filteredRecords = filteredRecords.filter(r => {
                    const d = new Date(r.date); return d.getMonth() === tm && d.getFullYear() === ty;
                });
                const totalRevenue = filteredRecords.reduce((sum, r) => sum + r.totalAmount, 0);
                const serviceRevenue = filteredRecords.reduce((sum, r) => sum + (r.serviceAmount || 0), 0);
                const productRevenue = filteredRecords.reduce((sum, r) => sum + (r.productAmount || 0), 0);
                const monthlyTarget = (currentUserConfig.hourlyRate * currentUserConfig.agreedHours) * 4;
                const rebookedClients = filteredRecords.filter(r => r.isRebook).length;
                return { totalRevenue, serviceRevenue, productRevenue, monthlyTarget, percentageToTarget: monthlyTarget > 0 ? (totalRevenue / monthlyTarget) * 100 : 0, rebookingRate: filteredRecords.length > 0 ? (rebookedClients/filteredRecords.length)*100 : 0, totalClients: filteredRecords.length, rebookedClients };
            },

            getGroupMetrics: (dateContext = new Date()) => {
                const tm = dateContext.getMonth(); const ty = dateContext.getFullYear();
                const filteredRecords = appState.records.filter(r => {
                    const d = new Date(r.date); return d.getMonth() === tm && d.getFullYear() === ty;
                });
                const totalRevenue = filteredRecords.reduce((sum, r) => sum + r.totalAmount, 0);
                const serviceRevenue = filteredRecords.reduce((sum, r) => sum + (r.serviceAmount || 0), 0);
                const productRevenue = filteredRecords.reduce((sum, r) => sum + (r.productAmount || 0), 0);
                const totalGroupTarget = appState.users.reduce((sum, u) => sum + ((u.hourlyRate * u.agreedHours) * 4), 0);
                const individualStats = appState.users.map(user => {
                    const userRecords = filteredRecords.filter(r => r.therapistEmail === user.email);
                    const userTotalRev = userRecords.reduce((sum, r) => sum + r.totalAmount, 0);
                    const userServiceRev = userRecords.reduce((sum, r) => sum + (r.serviceAmount || 0), 0);
                    const userProductRev = userRecords.reduce((sum, r) => sum + (r.productAmount || 0), 0);
                    const userTarget = (user.hourlyRate * user.agreedHours) * 4;
                    const userClients = userRecords.length;
                    const userRebooked = userRecords.filter(r => r.isRebook).length;
                    return {
                        name: user.name, revenue: userTotalRev, serviceRevenue: userServiceRev,
                        productRevenue: userProductRev,
                        targetPct: userTarget > 0 ? (userTotalRev / userTarget) * 100 : 0,
                        clients: userClients, rebooked: userRebooked,
                        rebookRate: userClients > 0 ? (userRebooked / userClients) * 100 : 0
                    };
                });
                return { totalRevenue, serviceRevenue, productRevenue, monthlyTarget: totalGroupTarget, percentageToTarget: totalGroupTarget > 0 ? (totalRevenue / totalGroupTarget) * 100 : 0, rebookingRate: filteredRecords.length > 0 ? (filteredRecords.filter(r => r.isRebook).length / filteredRecords.length) * 100 : 0, totalClients: filteredRecords.length, rebookedClients: filteredRecords.filter(r => r.isRebook).length, individualStats };
            },

            generateFakeData: () => {
                const now = new Date();
                const fakeClients = ["Alice Smith", "Bob Jones", "Charlie Day", "Diana Prince", "Evan Wright", "George Costanza", "Elaine Benes", "Cosmo Kramer"];
                for(let i=0; i<5; i++) {
                    const sA = Math.floor(Math.random() * 100) + 80;
                    const pA = Math.random() > 0.7 ? Math.floor(Math.random() * 40) + 10 : 0;
                    appState.records.push({
                        id: Date.now() + i, therapistEmail: appState.user.email, clientName: fakeClients[i % fakeClients.length],
                        service: SERVICES[Math.floor(Math.random() * SERVICES.length)],
                        serviceAmount: sA, productAmount: pA, totalAmount: sA + pA,
                        duration: "1h 15m", entryType: pA > 0 ? 'service_product' : 'service',
                        isNew: Math.random() > 0.5, isRebook: Math.random() > 0.6, date: now.toISOString()
                    });
                }
                for(let i=5; i<25; i++) {
                    const randomUser = appState.users[Math.floor(Math.random() * appState.users.length)];
                    const day = Math.floor(Math.random() * 27) + 1;
                    const recordDate = new Date(now.getFullYear(), now.getMonth(), day);
                    const sA = Math.floor(Math.random() * 150) + 50;
                    const pA = Math.random() > 0.8 ? Math.floor(Math.random() * 50) + 10 : 0;
                    appState.records.push({
                        id: Date.now() + i, therapistEmail: randomUser.email, clientName: fakeClients[Math.floor(Math.random() * fakeClients.length)],
                        service: SERVICES[Math.floor(Math.random() * SERVICES.length)],
                        serviceAmount: sA, productAmount: pA, totalAmount: sA + pA,
                        duration: "1h", entryType: 'service', isNew: Math.random() > 0.5, isRebook: Math.random() > 0.6, date: recordDate.toISOString()
                    });
                }
                UI.refreshStats();
                if(window.currentTab === 'dashboard') UI.renderTodayTable();
                if(window.currentTab === 'history') UI.renderHistoryTable();
                if(window.currentTab === 'group') UI.renderGroupStats();
                UI.showToast(`Seeded test data.`);
            },

            saveAllConfigs: () => {
                const rows = document.querySelectorAll('.config-row');
                rows.forEach(row => {
                    const email = row.dataset.email;
                    const userIndex = appState.users.findIndex(u => u.email === email);
                    if (userIndex !== -1) {
                        appState.users[userIndex].name = row.querySelector('.input-name').value;
                        appState.users[userIndex].hourlyRate = parseFloat(row.querySelector('.input-rate').value);
                        appState.users[userIndex].agreedHours = parseFloat(row.querySelector('.input-hours').value);
                    }
                });
                UI.showToast("Configuration saved.");
            }
        };

        // =========================================================================
        // UI HELPERS
        // =========================================================================

        const UI = {
            init: () => { UI.renderDashboard(); },
            
            toggleEntryFields: () => {
                const el = document.querySelector('input[name="entryType"]:checked'); if (!el) return;
                document.getElementById('serviceFields').classList.toggle('hidden', el.value === 'product');
                document.getElementById('durationFields').classList.toggle('hidden', el.value === 'product');
                document.getElementById('productFields').classList.toggle('hidden', el.value === 'service');
            },
            
            toggleEditEntryFields: () => {
                const el = document.querySelector('input[name="editEntryType"]:checked'); if (!el) return;
                document.getElementById('editServiceFields').classList.toggle('hidden', el.value === 'product');
                document.getElementById('editDurationFields').classList.toggle('hidden', el.value === 'product');
                document.getElementById('editProductFields').classList.toggle('hidden', el.value === 'service');
            },

            openEntryModal: () => {
                document.getElementById('entryModal').classList.remove('hidden');
                document.querySelector('[name="entryDate"]').value = new Date().toISOString().split('T')[0];
            },
            
            closeEntryModal: () => {
                document.getElementById('entryModal').classList.add('hidden');
                document.getElementById('dataEntryForm').reset();
                UI.toggleEntryFields();
            },

            openEditModal: (id) => {
                const r = appState.records.find(rec => rec.id === id); if (!r) return;
                const form = document.getElementById('editForm');
                form.dataset.id = id;
                form.querySelectorAll('input[name="editEntryType"]').forEach(radio => { 
                    if(radio.value === r.entryType) radio.checked = true; 
                });
                UI.toggleEditEntryFields();
                form.editClientName.value = r.clientName || '';
                form.editService.value = r.service === 'Product Sale' ? '' : r.service;
                form.editAmount.value = r.serviceAmount || 0;
                form.editProductAmount.value = r.productAmount || 0;
                form.editDate.value = new Date(r.date).toISOString().split('T')[0];
                if (r.duration) {
                    const hMatch = r.duration.match(/(\d+)h/);
                    const mMatch = r.duration.match(/(\d+)m/);
                    form.editDurationHours.value = hMatch ? hMatch[1] : "0";
                    form.editDurationMinutes.value = mMatch ? mMatch[1] : "0";
                }
                document.getElementById('editModal').classList.remove('hidden');
            },
            
            closeEditModal: () => { document.getElementById('editModal').classList.add('hidden'); },

            openDeleteModal: (id) => {
                appState.pendingDeleteId = id;
                document.getElementById('deleteModal').classList.remove('hidden');
            },
            closeDeleteModal: () => {
                appState.pendingDeleteId = null;
                document.getElementById('deleteModal').classList.add('hidden');
            },
            confirmDelete: () => {
                if(appState.pendingDeleteId) Logic.deleteRecord(appState.pendingDeleteId);
            },

            showToast: (m, t = 'success') => {
                const toast = document.createElement('div');
                toast.className = `fixed bottom-24 right-5 px-6 py-3 rounded-lg shadow-lg text-white z-[100] transform transition-all duration-300 translate-y-10 opacity-0 ${t === 'error' ? 'bg-red-500' : 'bg-teal-600'}`;
                toast.textContent = m; document.body.appendChild(toast);
                setTimeout(() => toast.classList.remove('translate-y-10', 'opacity-0'), 10);
                setTimeout(() => { toast.classList.add('translate-y-10', 'opacity-0'); setTimeout(() => toast.remove(), 300); }, 3000);
            },

            renderDashboard: () => {
                const isAdmin = appState.user.role === 'admin';
                document.body.innerHTML = `
                    <div class="min-h-screen bg-gray-50 flex flex-col font-inter">
                        <!-- MODALS -->
                        <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden flex items-center justify-center p-4">
                            <div class="bg-white rounded-xl shadow-2xl w-full max-w-xs p-6 text-center">
                                <h3 class="text-lg font-bold mb-4">Delete Entry?</h3>
                                <div class="flex space-x-3">
                                    <button onclick="UI.closeDeleteModal()" class="flex-1 py-2 bg-gray-100 rounded-lg text-xs">Cancel</button>
                                    <button onclick="UI.confirmDelete()" class="flex-1 py-2 bg-red-600 text-white rounded-lg text-xs font-bold">Delete</button>
                                </div>
                            </div>
                        </div>

                        <div id="entryModal" class="fixed inset-0 bg-black bg-opacity-50 z-[90] hidden flex items-center justify-center p-4">
                            <div class="bg-white rounded-xl shadow-xl w-full max-w-md overflow-y-auto max-h-[90vh]">
                                <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                                    <h3 class="text-sm font-bold text-gray-900 uppercase tracking-wider">New Performance Entry</h3>
                                    <button onclick="UI.closeEntryModal()" class="text-gray-400 hover:text-black"><i class="fas fa-times"></i></button>
                                </div>
                                <form id="dataEntryForm" class="p-6 space-y-4">
                                    <div class="flex justify-around border-b pb-4">
                                        <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="entryType" value="service" checked onchange="UI.toggleEntryFields()"> <span class="text-[10px] font-bold mt-1 uppercase text-gray-500">Service</span></label>
                                        <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="entryType" value="service_product" onchange="UI.toggleEntryFields()"> <span class="text-[10px] font-bold mt-1 uppercase text-gray-500">Svc+Prod</span></label>
                                        <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="entryType" value="product" onchange="UI.toggleEntryFields()"> <span class="text-[10px] font-bold mt-1 uppercase text-gray-500">Product</span></label>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div><label class="text-[10px] font-black uppercase text-gray-400 tracking-widest">Date</label><input type="date" name="entryDate" required class="w-full rounded border p-2 text-xs focus:ring-1 focus:ring-teal-500 outline-none shadow-sm"></div>
                                        <div><label class="text-[10px] font-black uppercase text-gray-400 tracking-widest">Client</label><input type="text" name="clientName" list="clientOptions" required class="w-full rounded border p-2 text-xs focus:ring-1 focus:ring-teal-500 outline-none shadow-sm" placeholder="Search or Enter"></div>
                                    </div>
                                    <div id="serviceFields" class="space-y-3">
                                        <select name="service" class="w-full rounded border p-2 text-xs focus:ring-1 focus:ring-teal-500 outline-none shadow-sm">${SERVICES.map(s => `<option value="${s}">${s}</option>`).join('')}</select>
                                        <input type="number" name="amount" step="0.01" class="w-full rounded border p-2 text-xs shadow-sm" placeholder="Service Amount $">
                                    </div>
                                    <div id="productFields" class="hidden"><input type="number" name="productAmount" step="0.01" class="w-full rounded border p-2 text-xs bg-blue-50 shadow-sm" placeholder="Product Amount $"></div>
                                    <div id="durationFields" class="flex space-x-2"><select name="durationHours" class="w-1/2 rounded border p-2 text-xs shadow-sm"><option value="0">0h</option><option value="1" selected>1h</option><option value="2">2h</option></select><select name="durationMinutes" class="w-1/2 rounded border p-2 text-xs shadow-sm"><option value="0">0m</option><option value="15">15m</option><option value="30">30m</option></select></div>
                                    <div class="flex space-x-4 pt-2"><label class="flex items-center cursor-pointer"><input type="checkbox" name="isNew" class="h-4 w-4 text-teal-600 rounded"> <span class="ml-2 text-xs font-medium text-gray-600">New Client</span></label><label class="flex items-center cursor-pointer"><input type="checkbox" name="isRebook" class="h-4 w-4 text-teal-600 rounded"> <span class="ml-2 text-xs font-medium text-gray-600">Rebooked</span></label></div>
                                    <button type="submit" class="w-full py-3 bg-teal-600 text-white rounded text-xs font-black uppercase tracking-widest hover:bg-teal-700 transition-colors shadow-lg active:scale-[0.98]">Confirm Entry</button>
                                </form>
                            </div>
                        </div>

                        <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 z-[90] hidden flex items-center justify-center p-4">
                            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                                <h3 class="text-xs font-black uppercase tracking-widest mb-4 text-gray-400">Edit Record</h3>
                                <form id="editForm" class="p-6 space-y-4">
                                    <div class="flex justify-around border-b pb-4">
                                        <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="editEntryType" value="service"> <span class="text-[10px] font-bold mt-1 uppercase text-gray-400">Service</span></label>
                                        <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="editEntryType" value="service_product"> <span class="text-[10px] font-bold mt-1 uppercase text-gray-400">Svc+Prod</span></label>
                                        <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="editEntryType" value="product"> <span class="text-[10px] font-bold mt-1 uppercase text-gray-400">Product</span></label>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div><label class="text-[10px] font-bold uppercase text-gray-400">Date</label><input type="date" name="editDate" required class="w-full border rounded p-2 text-xs"></div>
                                        <div><label class="text-[10px] font-bold uppercase text-gray-400">Client</label><input type="text" name="editClientName" required class="w-full border rounded p-2 text-xs" placeholder="Client Name"></div>
                                    </div>
                                    <div id="editServiceFields" class="space-y-4">
                                        <select name="editService" class="w-full border rounded p-2 text-xs">${SERVICES.map(s => `<option value="${s}">${s}</option>`).join('')}</select>
                                        <input type="number" name="editAmount" step="0.01" class="w-full border rounded p-2 text-xs">
                                    </div>
                                    <div id="editProductFields" class="hidden"><input type="number" name="editProductAmount" step="0.01" class="w-full border rounded p-2 text-xs bg-blue-50"></div>
                                    <div id="editDurationFields" class="flex space-x-2">
                                        <select name="editDurationHours" class="w-1/2 rounded border p-2 text-xs"><option value="0">0h</option><option value="1">1h</option><option value="2">2h</option></select>
                                        <select name="editDurationMinutes" class="w-1/2 rounded border p-2 text-xs"><option value="0">0m</option><option value="15">15m</option><option value="30">30m</option></select>
                                    </div>
                                    <div class="flex space-x-2 pt-2"><button type="button" onclick="UI.closeEditModal()" class="flex-1 py-2 bg-gray-100 rounded text-[10px] font-black uppercase">Cancel</button><button type="submit" class="flex-1 py-2 bg-teal-600 text-white rounded text-[10px] font-black uppercase">Update</button></div>
                                </form>
                            </div>
                        </div>

                        <!-- HEADER -->
                        <header class="bg-white shadow-sm sticky top-0 z-40 p-3 flex justify-between items-center border-b border-gray-100">
                            <div class="flex flex-col">
                                <h1 class="text-xl font-black tracking-tighter leading-none">TRB<span class="text-teal-500">.</span></h1>
                                <span class="text-[8px] font-black text-gray-300 uppercase tracking-widest mt-1">v${APP_VERSION}</span>
                            </div>
                            <div class="flex space-x-2 items-center">
                                <button onclick="Logic.generateFakeData()" class="bg-gray-50 text-[9px] font-black uppercase border border-gray-200 rounded px-2.5 py-2 hover:bg-gray-100 transition-colors shadow-sm">Seed Data</button>
                                <select onchange="Logic.switchUser(this.value)" class="bg-gray-50 text-[9px] font-black uppercase border border-gray-200 rounded px-2 py-1.5 focus:ring-0 shadow-sm">
                                    ${appState.users.map(u => `<option value="${u.email}" ${appState.user.email === u.email ? 'selected' : ''}>${u.name}</option>`).join('')}
                                </select>
                                <button onclick="UI.openEntryModal()" class="bg-teal-600 text-white px-3 py-2 rounded-lg shadow-md text-[9px] font-black uppercase tracking-wider hover:bg-teal-700 transition-all active:scale-95 flex items-center">
                                    <i class="fas fa-plus mr-1"></i> New Entry
                                </button>
                            </div>
                        </header>

                        <!-- MAIN CONTENT -->
                        <main class="flex-1 overflow-y-auto pb-24 p-4" id="main-content"></main>

                        <!-- FOOTER NAVIGATION -->
                        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 shadow-[0_-4px_12px_rgba(0,0,0,0.05)] z-50 flex justify-around items-center px-2 py-2">
                            <button onclick="UI.switchTab('dashboard')" id="nav-dashboard" class="flex flex-col items-center justify-center w-1/4 transition-all py-1">
                                <i class="fas fa-chart-line text-lg mb-1"></i>
                                <span class="text-[9px] font-black uppercase tracking-tight">Me</span>
                            </button>
                            <button onclick="UI.switchTab('history')" id="nav-history" class="flex flex-col items-center justify-center w-1/4 transition-all py-1">
                                <i class="fas fa-history text-lg mb-1"></i>
                                <span class="text-[9px] font-black uppercase tracking-tight">History</span>
                            </button>
                            <button onclick="UI.switchTab('group')" id="nav-group" class="flex flex-col items-center justify-center w-1/4 transition-all py-1">
                                <i class="fas fa-people-group text-lg mb-1"></i>
                                <span class="text-[9px] font-black uppercase tracking-tight">Group</span>
                            </button>
                            ${isAdmin ? `<button onclick="UI.switchTab('config')" id="nav-config" class="flex flex-col items-center justify-center w-1/4 transition-all py-1"><i class="fas fa-sliders text-lg mb-1"></i><span class="text-[9px] font-black uppercase tracking-tight">Setup</span></button>` : ''}
                        </nav>
                    </div>
                `;
                
                // Form submissions
                document.getElementById('dataEntryForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    const sa = parseFloat(fd.get('amount') || 0); const pa = parseFloat(fd.get('productAmount') || 0);
                    const h = parseInt(fd.get('durationHours') || 0); const m = parseInt(fd.get('durationMinutes') || 0);
                    let d = ""; if (h > 0) d += `${h}h `; if (m > 0 || h == 0) d += `${m}m`;
                    Logic.addRecord(fd.get('clientName'), fd.get('service'), sa, pa, d.trim(), fd.get('entryType'), fd.get('isNew') === 'on', fd.get('isRebook') === 'on', fd.get('entryDate'));
                });

                document.getElementById('editForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    const id = parseInt(e.target.dataset.id);
                    const h = parseInt(fd.get('editDurationHours') || 0); const m = parseInt(fd.get('editDurationMinutes') || 0);
                    let d = ""; if (h > 0) d += `${h}h `; if (m > 0 || h == 0) d += `${m}m`;
                    Logic.updateRecord(id, {
                        date: new Date(fd.get('editDate')).toISOString(),
                        clientName: fd.get('editClientName'),
                        service: fd.get('editEntryType') === 'product' ? 'Product Sale' : fd.get('editService'),
                        serviceAmount: parseFloat(fd.get('editAmount') || 0),
                        productAmount: parseFloat(fd.get('editProductAmount') || 0),
                        duration: fd.get('editEntryType') === 'product' ? null : d.trim(),
                        entryType: fd.get('editEntryType'),
                    });
                });

                UI.switchTab('dashboard');
            },

            switchTab: (tabName) => {
                window.currentTab = tabName;
                document.querySelectorAll('nav button').forEach(b => {
                    const isActive = b.id === `nav-${tabName}`;
                    b.classList.toggle('text-teal-600', isActive);
                    b.classList.toggle('text-gray-300', !isActive);
                    if (isActive) b.classList.add('scale-110'); else b.classList.remove('scale-110');
                });
                const main = document.getElementById('main-content');
                if (tabName === 'dashboard') {
                    main.innerHTML = `<div id="stats-container"></div><div id="activity-container"></div>`;
                    UI.refreshStats(); UI.renderTodayTable();
                } else if (tabName === 'history') {
                    main.innerHTML = `<div id="history-container"></div>`;
                    UI.renderHistoryTable();
                } else if (tabName === 'group') {
                    main.innerHTML = `<div id="group-stats-container"></div>`;
                    UI.renderGroupStats();
                } else if (tabName === 'config') {
                    main.innerHTML = `<div id="config-container"></div>`;
                    UI.renderConfigTable();
                }
            },

            refreshStats: () => {
                if (window.currentTab !== 'dashboard') return;
                const m = Logic.getMetrics(null, appState.currentDate);
                const cm = appState.currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                const maxVal = Math.max(m.totalRevenue, m.monthlyTarget, 1);
                const ah = (m.totalRevenue / maxVal) * 100;
                const th = (m.monthlyTarget / maxVal) * 100;
                document.getElementById('stats-container').innerHTML = `
                    <div class="bg-white p-4 rounded-2xl border border-gray-100 mb-4 shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Performance</h3>
                            <div class="flex items-center space-x-1 bg-gray-50 rounded-lg p-0.5 border">
                                <button onclick="Logic.changeMonth(-1)" class="p-1"><i class="fas fa-chevron-left text-[10px]"></i></button>
                                <span class="text-[9px] font-black w-20 text-center uppercase">${cm}</span>
                                <button onclick="Logic.changeMonth(1)" class="p-1"><i class="fas fa-chevron-right text-[10px]"></i></button>
                            </div>
                        </div>
                        <div class="flex justify-center items-end space-x-12 h-40 border-b border-gray-50 pb-2 mb-4">
                            <div class="flex flex-col items-center w-16 h-full justify-end">
                                <span class="text-[9px] font-black text-teal-600 mb-1">${m.percentageToTarget.toFixed(0)}%</span>
                                <span class="text-[10px] font-black text-teal-600 mb-1">$${m.totalRevenue.toLocaleString()}</span>
                                <div style="height: ${ah}%; min-height:4px" class="w-12 bg-teal-500 rounded-t shadow-md transition-all duration-1000"></div>
                                <span class="mt-2 text-[8px] font-black text-gray-300 uppercase">Actual</span>
                            </div>
                            <div class="flex flex-col items-center w-16 h-full justify-end">
                                <span class="text-[10px] font-black text-blue-600 mb-1">$${m.monthlyTarget.toLocaleString()}</span>
                                <div style="height: ${th}%; min-height:4px" class="w-12 bg-blue-100 border-t border-x border-blue-100 rounded-t shadow-sm transition-all duration-1000"></div>
                                <span class="mt-2 text-[8px] font-black text-gray-300 uppercase tracking-widest">Goal</span>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm"><p class="text-[8px] font-black text-gray-400 uppercase tracking-widest mb-1">Total</p><p class="text-lg font-black text-gray-900">$${m.totalRevenue.toLocaleString()}</p></div>
                        <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm"><p class="text-[8px] font-black text-gray-400 uppercase tracking-widest mb-1">Target</p><p class="text-lg font-black text-gray-900">$${m.monthlyTarget.toLocaleString()}</p></div>
                        <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm"><p class="text-[8px] font-black text-gray-400 uppercase tracking-widest mb-1">Progress</p><p class="text-lg font-black text-teal-600">${m.percentageToTarget.toFixed(1)}%</p></div>
                        <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm"><p class="text-[8px] font-black text-gray-400 uppercase tracking-widest mb-1">Rebook</p><p class="text-lg font-black text-purple-600">${m.rebookingRate.toFixed(1)}%</p></div>
                    </div>`;
            },

            renderGroupStats: () => {
                const m = Logic.getGroupMetrics(appState.currentDate);
                const cm = appState.currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                const ah = Math.min((m.totalRevenue / Math.max(m.totalRevenue, m.monthlyTarget, 1)) * 100, 100);
                const cols = ['bg-teal-400', 'bg-sky-400', 'bg-violet-400', 'bg-rose-400', 'bg-amber-400'];
                const segs = m.individualStats.map((s, i) => s.revenue <= 0 ? '' : `<div style="height: ${(s.revenue/m.totalRevenue)*100}%" class="${cols[i%cols.length]} border-b border-white/20"></div>`).join('');
                const legs = m.individualStats.map((s, i) => `<div class="flex items-center text-[8px] text-gray-600 font-black uppercase tracking-tight"><span class="w-1.5 h-1.5 rounded-full ${cols[i % cols.length]} mr-1"></span>${s.name}</div>`).join('');
                
                document.getElementById('group-stats-container').innerHTML = `
                    <div class="bg-white p-4 rounded-2xl border border-gray-100 mb-4 shadow-sm">
                        <h3 class="text-[10px] font-black text-gray-300 uppercase tracking-widest mb-4">Team Performance</h3>
                        <div class="flex justify-center items-end space-x-16 h-48 border-b border-gray-50 pb-2 mb-4">
                            <div class="flex flex-col items-center w-16 h-full justify-end">
                                <span class="text-[10px] font-black text-teal-600 mb-1">$${m.totalRevenue.toLocaleString()}</span>
                                <div style="height: ${ah}%;" class="w-12 rounded-t flex flex-col-reverse overflow-hidden shadow-md">${segs}</div>
                                <span class="mt-2 text-[8px] font-black text-gray-300 uppercase tracking-widest">Total</span>
                            </div>
                            <div class="flex flex-col items-center w-16 h-full justify-end">
                                <span class="text-[10px] font-black text-blue-600 mb-1">$${m.monthlyTarget.toLocaleString()}</span>
                                <div style="height:100%" class="w-12 bg-blue-50 border-t border-x border-blue-100 rounded-t shadow-sm"></div>
                                <span class="mt-2 text-[8px] font-black text-gray-300 uppercase tracking-widest">Team Target</span>
                            </div>
                        </div>
                        <div class="flex flex-wrap justify-center gap-x-4 gap-y-1.5 mt-3">${legs}</div>
                    </div>

                    <div class="bg-white rounded-xl border border-gray-100 p-6 shadow-sm overflow-x-auto mb-4">
                        <h3 class="text-sm font-bold mb-4">Therapist Breakdown</h3>
                        <table class="min-w-full">
                            <thead class="bg-gray-50 border-b">
                                <tr class="text-[9px] text-gray-400 uppercase tracking-widest font-black">
                                    <th class="text-left py-3 px-2">Therapist</th>
                                    <th class="text-right py-3 px-2">Total Rev</th>
                                    <th class="text-right py-3 px-2">Svc ($)</th>
                                    <th class="text-right py-3 px-2">Prod ($)</th>
                                    <th class="text-right py-3 px-2">Target %</th>
                                    <th class="text-right py-3 px-2">Rebook %</th>
                                    <th class="text-center py-3 px-2">Clients</th>
                                    <th class="text-center py-3 px-2">Rebooked</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${m.individualStats.map(s => `
                                    <tr class="hover:bg-gray-50/50">
                                        <td class="py-3 px-2 text-xs font-bold text-gray-900">${s.name}</td>
                                        <td class="py-3 px-2 text-xs text-right font-bold text-gray-900">$${s.revenue.toLocaleString()}</td>
                                        <td class="py-3 px-2 text-xs text-right text-gray-400">$${s.serviceRevenue.toLocaleString()}</td>
                                        <td class="py-3 px-2 text-xs text-right text-blue-600 font-medium">$${s.productRevenue.toLocaleString()}</td>
                                        <td class="py-3 px-2 text-xs text-right text-gray-400">${s.targetPct.toFixed(1)}%</td>
                                        <td class="py-3 px-2 text-xs text-right font-bold text-gray-900">${s.rebookRate.toFixed(1)}%</td>
                                        <td class="py-3 px-2 text-xs text-center text-gray-400">${s.clients}</td>
                                        <td class="py-3 px-2 text-xs text-center text-gray-400">${s.rebooked}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`;
            },

            renderTodayTable: () => {
                const cont = document.getElementById('activity-container'); if (!cont) return;
                const today = new Date(); today.setHours(0,0,0,0);
                const records = appState.records.filter(r => {
                    const rd = new Date(r.date); rd.setHours(0,0,0,0);
                    return rd.getTime() === today.getTime() && r.therapistEmail === appState.user.email;
                }).sort((a, b) => new Date(a.date) - new Date(b.date));
                cont.innerHTML = `
                    <div class="bg-white rounded-2xl border border-gray-100 p-4 shadow-sm">
                        <h3 class="text-[10px] font-black text-gray-300 uppercase tracking-widest mb-4">Recent Activity</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50 border-b">
                                    <tr class="text-[8px] font-black text-gray-400 uppercase tracking-tighter">
                                        <th class="text-left py-1.5 px-1 w-12">Time</th>
                                        <th class="text-left py-1.5 px-1">Client/Service</th>
                                        <th class="text-right py-1.5 px-1">Total</th>
                                        <th class="text-center py-1.5 px-1">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-50">${records.length === 0 ? '<tr><td colspan="4" class="py-6 text-center text-gray-400 text-[10px] italic">No activity yet.</td></tr>' : records.map(r => `
                                    <tr class="hover:bg-gray-50/50">
                                        <td class="py-2 px-1 text-[9px] font-black text-gray-400 uppercase">${new Date(r.date).toLocaleTimeString([], {hour:'numeric', minute:'2-digit', hour12:true})}</td>
                                        <td class="py-2 px-1">
                                            <div class="flex flex-col">
                                                <span class="text-[11px] font-bold text-gray-800 leading-tight">${r.clientName}</span>
                                                <span class="text-[9px] text-gray-500 truncate max-w-[140px]">${r.service}</span>
                                                <div class="flex items-center mt-0.5 space-x-1">
                                                    ${r.duration ? `<span class="text-[8px] font-bold text-gray-300"><i class="far fa-clock mr-0.5"></i>${r.duration}</span>` : ''}
                                                    ${r.productAmount > 0 ? `<span class="text-[8px] font-bold text-blue-400"><i class="fas fa-shopping-bag mr-0.5"></i>$${r.productAmount}P</span>` : ''}
                                                    ${r.isRebook ? `<span class="text-[7px] font-black bg-purple-50 text-purple-400 px-1 rounded uppercase">Rebook</span>` : ''}
                                                </div>
                                            </div>
                                        </td>
                                        <td class="py-2 px-1 text-[11px] font-black text-right text-gray-900">$${r.totalAmount.toFixed(2)}</td>
                                        <td class="py-2 px-1">
                                            <div class="flex justify-center space-x-2">
                                                <button onclick="UI.openEditModal(${r.id})" class="text-gray-200 hover:text-teal-600 transition-colors p-1"><i class="fas fa-pencil-alt text-[9px]"></i></button>
                                                <button onclick="UI.openDeleteModal(${r.id})" class="text-gray-100 hover:text-red-500 transition-colors p-1"><i class="fas fa-trash text-[9px]"></i></button>
                                            </div>
                                        </td>
                                    </tr>`).join('')}</tbody>
                            </table>
                        </div>
                    </div>`;
            },

            renderHistoryTable: () => {
                const cont = document.getElementById('history-container'); if (!cont) return;
                const tm = appState.currentDate.getMonth(); const ty = appState.currentDate.getFullYear();
                const cm = appState.currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                const records = appState.records.filter(r => {
                    const rd = new Date(r.date); return rd.getMonth() === tm && rd.getFullYear() === ty && r.therapistEmail === appState.user.email;
                }).sort((a, b) => new Date(a.date) - new Date(b.date));
                cont.innerHTML = `
                    <div class="bg-white rounded-2xl border border-gray-100 p-4 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-[10px] font-black text-gray-300 uppercase tracking-widest">${cm} Log</h3>
                            <div class="flex space-x-1">
                                <button onclick="Logic.changeMonth(-1)" class="p-1.5 bg-gray-50 rounded-lg text-gray-400"><i class="fas fa-chevron-left text-[10px]"></i></button>
                                <button onclick="Logic.changeMonth(1)" class="p-1.5 bg-gray-50 rounded-lg text-gray-400"><i class="fas fa-chevron-right text-[10px]"></i></button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50 border-b">
                                    <tr class="text-[8px] font-black text-gray-400 uppercase tracking-tighter">
                                        <th class="text-left py-1.5 px-1 w-12">Date</th>
                                        <th class="text-left py-1.5 px-1">Client/Info</th>
                                        <th class="text-right py-1.5 px-1">Total</th>
                                        <th class="text-center py-1.5 px-1">Edit</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-50">${records.length === 0 ? '<tr><td colspan="4" class="py-10 text-center text-gray-400 text-xs italic">No historical data.</td></tr>' : records.map(r => `
                                    <tr>
                                        <td class="py-2 px-1 text-[9px] font-black text-gray-300">${new Date(r.date).toLocaleDateString([], { month: 'numeric', day: 'numeric' })}</td>
                                        <td class="py-2 px-1">
                                            <div class="flex flex-col">
                                                <span class="text-[11px] font-bold text-gray-800 leading-tight">${r.clientName}</span>
                                                <span class="text-[9px] text-gray-400 truncate max-w-[120px]">${r.service}</span>
                                            </div>
                                        </td>
                                        <td class="py-2 px-1 text-[11px] font-black text-right text-gray-900">$${r.totalAmount.toFixed(2)}</td>
                                        <td class="py-2 px-1 text-center"><button onclick="UI.openEditModal(${r.id})" class="text-gray-200 hover:text-teal-600 transition-colors"><i class="fas fa-pencil-alt text-[10px]"></i></button></td>
                                    </tr>`).join('')}</tbody>
                            </table>
                        </div>
                    </div>`;
            },

            renderConfigTable: () => {
                const cont = document.getElementById('config-container'); if (!cont) return;
                cont.innerHTML = `
                    <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                        <div class="p-4 border-b bg-gray-50 flex justify-between items-center"><h3 class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Staff Configuration</h3><button onclick="Logic.saveAllConfigs()" class="bg-black text-white px-4 py-2 rounded-lg text-[9px] font-black uppercase tracking-widest shadow hover:bg-gray-800 active:scale-95 transition-all">Save All</button></div>
                        <div class="p-4 space-y-4 divide-y divide-gray-50">${appState.users.map(u => `
                            <div class="config-row space-y-2 py-4 first:pt-0" data-email="${u.email}">
                                <div class="flex justify-between items-center mb-2"><span class="text-[10px] font-black text-gray-800 uppercase tracking-tighter">${u.email}</span><span class="text-[8px] bg-black text-white px-2 py-0.5 rounded-full uppercase font-black">${u.role}</span></div>
                                <div class="grid grid-cols-3 gap-2">
                                    <div class="flex flex-col"><label class="text-[7px] font-black text-gray-400 uppercase mb-1">Display Name</label><input type="text" value="${u.name}" class="input-name border rounded p-1.5 text-xs"></div>
                                    <div class="flex flex-col"><label class="text-[7px] font-black text-gray-400 uppercase mb-1">Hourly Rate ($)</label><input type="number" value="${u.hourlyRate}" class="input-rate border rounded p-1.5 text-xs"></div>
                                    <div class="flex flex-col"><label class="text-[7px] font-black text-gray-400 uppercase mb-1">Weekly Hours</label><input type="number" value="${u.agreedHours}" class="input-hours border rounded p-1.5 text-xs"></div>
                                </div>
                            </div>`).join('')}</div>
                    </div>`;
            }
        };

        window.UI = UI; window.Logic = Logic;
        window.addEventListener('DOMContentLoaded', UI.init);
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { display: none; }
        input, select, button { outline: none !important; }
        .font-inter { font-family: 'Inter', sans-serif; }
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    </style>
</head>
<body><div id="app"></div></body>
</html>