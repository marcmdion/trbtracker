<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRB | Beauty Clinic Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Minimalistic Light Theme Configuration
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            background-color: #f9fafb; /* gray-50 */
            color: #111827; /* gray-900 */
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        
        /* Custom scrollbar for a sleek minimal look */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #e5e7eb; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #d1d5db; 
        }

        .hide-scroll::-webkit-scrollbar {
            display: none;
        }

        /* Input styling overrides */
        input, select, textarea {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            color: #111827;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #111827;
            box-shadow: 0 0 0 1px #111827;
        }

        /* SVG Icon styles */
        .nav-icon {
            width: 24px;
            height: 24px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        /* Toast animation */
        @keyframes slideInUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .toast-enter {
            animation: slideInUp 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="flex h-screen w-full antialiased selection:bg-gray-200 selection:text-gray-900 bg-gray-50 text-gray-900">

    <!-- Toast Notifications Container -->
    <div id="toast-container" class="fixed bottom-24 right-4 z-[60] flex flex-col gap-2"></div>

    <!-- APP WRAPPER -->
    <div id="app-wrapper" class="flex h-full w-full relative hidden flex-col">
        
        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col h-full overflow-hidden relative pb-20">
            
            <!-- Top Header -->
            <header class="bg-white/90 backdrop-blur-md border-b border-gray-200 p-4 flex justify-between items-center sticky top-0 z-20">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gray-900 flex items-center justify-center font-bold text-white text-xs">T</div>
                    <h1 class="text-lg font-bold text-gray-900 tracking-wider">TRB</h1>
                    <div class="h-6 w-px bg-gray-300 mx-2 hidden sm:block"></div>
                    <h2 class="text-lg font-semibold text-gray-500 hidden sm:block" id="page-title">Dashboard</h2>
                </div>
                
                <div class="flex items-center gap-4">
                    <button onclick="logoutApp()" class="text-gray-400 hover:text-gray-900 transition-colors" title="Logout">
                        <svg class="nav-icon w-5 h-5" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    </button>
                    <button onclick="openQuickAddModal()" class="bg-gray-900 hover:bg-gray-800 text-white px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-colors shadow-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        Quick Add
                    </button>
                </div>
            </header>

            <!-- Scrollable Sections Container -->
            <div class="flex-1 overflow-y-auto p-4 md:p-8" id="sections-container">
                
                <!-- SECTION: ME (Dashboard) -->
                <section id="section-me" class="space-y-6 hidden active-section">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Welcome & Stats -->
                        <div class="md:col-span-2 space-y-6">
                            <div class="bg-white border border-gray-200 p-6 rounded-2xl shadow-sm">
                                <h3 class="text-2xl font-bold mb-1 text-gray-900">Hello, <span id="dash-name" class="text-gray-500 font-medium">Therapist</span></h3>
                                <p class="text-gray-500 text-sm mb-6">Here is your performance for <span id="current-month-label">this month</span>.</p>
                                
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                        <p class="text-gray-500 text-xs mb-1 font-medium">Total Revenue</p>
                                        <p class="text-xl font-bold text-gray-900" id="stat-revenue">$0</p>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                        <p class="text-gray-500 text-xs mb-1 font-medium">Services</p>
                                        <p class="text-xl font-bold text-gray-900" id="stat-services">$0</p>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                        <p class="text-gray-500 text-xs mb-1 font-medium">Retail</p>
                                        <p class="text-xl font-bold text-gray-900" id="stat-retail">$0</p>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                        <p class="text-gray-500 text-xs mb-1 font-medium">Rebooking %</p>
                                        <p class="text-xl font-bold text-gray-900" id="stat-rebook">0%</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Charts -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-white border border-gray-200 p-6 rounded-2xl shadow-sm flex flex-col">
                                    <h4 class="font-semibold mb-4 text-xs text-gray-400 uppercase tracking-wider">Sales vs Goal</h4>
                                    <div class="relative h-48 w-full flex justify-center items-center flex-1">
                                        <canvas id="goalChart"></canvas>
                                    </div>
                                    <div class="mt-6 space-y-2 text-sm">
                                        <div class="flex justify-between border-b border-gray-100 pb-2">
                                            <span class="text-gray-500 font-medium">Target:</span>
                                            <span class="text-gray-900 font-bold" id="me-goal-target">$0.00</span>
                                        </div>
                                        <div class="flex justify-between border-b border-gray-100 pb-2">
                                            <span class="text-gray-500 font-medium">Achieved:</span>
                                            <span class="text-gray-900 font-bold" id="me-goal-achieved">$0.00</span>
                                        </div>
                                        <div class="flex justify-between pt-1">
                                            <span class="text-gray-500 font-medium">Remaining:</span>
                                            <span class="text-gray-900 font-bold" id="me-goal-remaining">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-white border border-gray-200 p-6 rounded-2xl shadow-sm flex flex-col">
                                    <h4 class="font-semibold mb-4 text-xs text-gray-400 uppercase tracking-wider">Revenue Breakdown</h4>
                                    <div class="relative h-48 w-full flex justify-center items-center flex-1">
                                        <canvas id="breakdownChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Daily Appointments -->
                        <div class="bg-white border border-gray-200 rounded-2xl flex flex-col h-full shadow-sm overflow-hidden">
                            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                                <h4 class="font-semibold text-xs text-gray-500 uppercase tracking-wider">Today's Schedule</h4>
                                <span class="bg-white border border-gray-200 text-gray-600 font-medium text-xs px-2 py-1 rounded-md" id="today-date-badge">Date</span>
                            </div>
                            <div class="p-5 flex-1 overflow-y-auto space-y-3" id="appointments-list">
                                <!-- Populated via JS -->
                            </div>
                            <div class="p-4 border-t border-gray-100 bg-gray-50/50">
                                <button onclick="openAppointmentModal()" class="w-full bg-white border border-gray-200 hover:bg-gray-50 hover:border-gray-300 text-gray-700 py-2 rounded-lg text-sm transition font-medium shadow-sm">
                                    + Add Appointment
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- SECTION: HISTORY -->
                <section id="section-history" class="space-y-6 hidden">
                    <div class="bg-white border border-gray-200 rounded-2xl overflow-hidden shadow-sm">
                        <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                            <h3 class="font-semibold text-gray-900">Recent Sales</h3>
                            <select id="history-month-filter" class="bg-white border border-gray-200 rounded-lg px-3 py-1.5 text-sm font-medium shadow-sm" onchange="renderHistory()">
                                <!-- Populated via JS -->
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm whitespace-nowrap">
                                <thead class="bg-gray-50 border-b border-gray-200 text-gray-500">
                                    <tr>
                                        <th class="px-6 py-4 font-medium">Date</th>
                                        <th class="px-6 py-4 font-medium">Client</th>
                                        <th class="px-6 py-4 font-medium">Therapist</th>
                                        <th class="px-6 py-4 font-medium">Services ($)</th>
                                        <th class="px-6 py-4 font-medium">Retail ($)</th>
                                        <th class="px-6 py-4 font-medium text-right">Total</th>
                                        <th class="px-6 py-4 font-medium text-center">Tags</th>
                                    </tr>
                                </thead>
                                <tbody id="history-table-body" class="divide-y divide-gray-100">
                                    <!-- Populated via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- SECTION: CLIENTS -->
                <section id="section-clients" class="space-y-6 hidden h-full flex flex-col">
                    <div class="flex gap-4">
                        <div class="relative flex-1">
                            <svg class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            <input type="text" id="client-search" oninput="renderClientsList()" placeholder="Search clients by name or phone..." class="w-full pl-10 pr-4 py-3 rounded-xl bg-white border border-gray-200 focus:border-gray-900 shadow-sm transition-colors">
                        </div>
                        <button onclick="openClientModal(null)" class="bg-white border border-gray-200 hover:border-gray-400 text-gray-900 font-medium px-6 py-3 rounded-xl transition-colors shadow-sm whitespace-nowrap">
                            + New Client
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 auto-rows-max" id="clients-grid">
                        <!-- Populated via JS -->
                    </div>
                </section>

                <!-- SECTION: GROUP -->
                <section id="section-group" class="space-y-6 hidden">
                    <!-- Team Stats Summary -->
                    <div class="bg-white border border-gray-200 p-6 rounded-2xl shadow-sm">
                        <h3 class="text-xl font-bold mb-1 text-gray-900">Team Overview</h3>
                        <p class="text-gray-500 text-sm mb-6">Here is the clinic's performance for this week.</p>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                <p class="text-gray-500 text-xs mb-1 font-medium">Total Revenue</p>
                                <p class="text-xl font-bold text-gray-900" id="group-stat-revenue">$0</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                <p class="text-gray-500 text-xs mb-1 font-medium">Services</p>
                                <p class="text-xl font-bold text-gray-900" id="group-stat-services">$0</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                <p class="text-gray-500 text-xs mb-1 font-medium">Retail</p>
                                <p class="text-xl font-bold text-gray-900" id="group-stat-retail">$0</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                <p class="text-gray-500 text-xs mb-1 font-medium">Rebooking %</p>
                                <p class="text-xl font-bold text-gray-900" id="group-stat-rebook">0%</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Team Goal -->
                        <div class="bg-white border border-gray-200 shadow-sm p-6 rounded-2xl flex flex-col">
                            <h3 class="font-semibold mb-4 text-xs text-gray-400 uppercase tracking-wider">Team Sales vs Goal</h3>
                            <div class="relative h-48 w-full flex justify-center items-center flex-1">
                                <canvas id="groupGoalChart"></canvas>
                            </div>
                            <div class="mt-6 space-y-2 text-sm">
                                <div class="flex justify-between border-b border-gray-100 pb-2">
                                    <span class="text-gray-500 font-medium">Target:</span>
                                    <span class="text-gray-900 font-bold" id="group-goal-target">$0.00</span>
                                </div>
                                <div class="flex justify-between border-b border-gray-100 pb-2">
                                    <span class="text-gray-500 font-medium">Achieved:</span>
                                    <span class="text-gray-900 font-bold" id="group-goal-achieved">$0.00</span>
                                </div>
                                <div class="flex justify-between pt-1">
                                    <span class="text-gray-500 font-medium">Remaining:</span>
                                    <span class="text-gray-900 font-bold" id="group-goal-remaining">$0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Team Leaderboard -->
                        <div class="lg:col-span-2 bg-white border border-gray-200 shadow-sm p-6 rounded-2xl">
                            <h3 class="font-semibold mb-6 text-gray-900">Team Performance (This Week)</h3>
                            <div class="relative h-64 w-full">
                                <canvas id="teamChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-6">
                        <!-- Top Treatments -->
                        <div class="bg-white border border-gray-200 shadow-sm p-6 rounded-2xl flex flex-col">
                            <h3 class="font-semibold mb-6 text-gray-900">Popular Treatments (This Week)</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4" id="top-treatments-list">
                                <!-- Populated via JS -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- SECTION: SETUP (Manager Only) -->
                <section id="section-setup" class="space-y-6 hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Staff Management -->
                        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
                            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                                <h3 class="font-semibold text-gray-900">Staff Management</h3>
                                <button onclick="openStaffModal()" class="text-xs font-medium bg-gray-900 text-white px-3 py-1.5 rounded-md hover:bg-gray-800 transition shadow-sm">+ Add Staff</button>
                            </div>
                            <div class="p-5 space-y-4 bg-white" id="setup-staff-list">
                                <!-- Populated via JS -->
                            </div>
                        </div>

                        <!-- Services Menu -->
                        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
                            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                                <h3 class="font-semibold text-gray-900">Service Menu</h3>
                                <button onclick="openServiceModal()" class="text-xs font-medium bg-gray-900 text-white px-3 py-1.5 rounded-md hover:bg-gray-800 transition shadow-sm">+ Add Service</button>
                            </div>
                            <div class="p-5 space-y-3 bg-white" id="setup-services-list">
                                <!-- Populated via JS -->
                            </div>
                        </div>
                    </div>
                </section>

            </div>
        </main>

        <!-- Bottom Navigation (Static) -->
        <nav class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-lg border-t border-gray-200 flex justify-center gap-2 sm:gap-12 items-center p-3 pb-safe z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]" id="bottom-nav">
            <!-- Nav items injected via JS -->
        </nav>
    </div>

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="fixed inset-0 bg-gray-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white border border-gray-200 p-8 rounded-3xl w-full max-w-md shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-16 h-16 rounded-full bg-gray-900 flex items-center justify-center font-bold text-white text-2xl mx-auto mb-4">T</div>
                <h1 class="text-2xl font-bold tracking-wider text-gray-900">TRB</h1>
                <p class="text-gray-500 mt-2 text-sm font-medium" id="login-subtitle">Clinic Staff Portal</p>
            </div>
            
            <form id="login-form" class="space-y-5" onsubmit="handleLogin(event)">
                <div id="setup-notice" class="hidden bg-gray-100 border border-gray-200 p-3 rounded-lg text-sm text-gray-700 font-medium mb-4 text-center">
                    First time setup: Create the master manager account.
                </div>
                
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1.5 uppercase tracking-wide">Email Address</label>
                    <input type="email" id="login-email" required class="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-200 focus:border-gray-900 transition-colors">
                </div>
                
                <div id="login-name-field" class="hidden">
                    <label class="block text-xs font-semibold text-gray-600 mb-1.5 uppercase tracking-wide">Full Name</label>
                    <input type="text" id="login-name" class="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-200 focus:border-gray-900 transition-colors">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1.5 uppercase tracking-wide">PIN / Password</label>
                    <input type="password" id="login-pin" required class="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-200 focus:border-gray-900 transition-colors">
                </div>
                
                <button type="submit" class="w-full bg-gray-900 hover:bg-gray-800 text-white shadow-md font-medium py-3 rounded-xl transition-colors mt-2" id="login-btn">
                    Access Dashboard
                </button>
            </form>
            
            <div id="loading-overlay" class="hidden absolute inset-0 bg-white/90 flex flex-col items-center justify-center rounded-3xl backdrop-blur-sm z-10">
                <div class="w-8 h-8 border-4 border-gray-200 border-t-gray-900 rounded-full animate-spin"></div>
                <p class="mt-4 text-sm font-medium animate-pulse text-gray-700">Connecting to Clinic...</p>
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- Quick Add Sale Modal -->
    <div id="modal-quick-add" class="fixed inset-0 bg-gray-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white border border-gray-200 rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg text-gray-900">Log New Sale</h3>
                <button onclick="closeModal('modal-quick-add')" class="text-gray-400 hover:text-gray-900">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 space-y-5">
                <form id="form-quick-add" onsubmit="submitQuickAdd(event)" class="space-y-5">
                    
                    <!-- Date & Staff -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase">Date</label>
                            <input type="date" id="qa-date" required class="w-full px-3 py-2 rounded-lg text-sm bg-gray-50 border border-gray-200">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase">Therapist</label>
                            <select id="qa-staff" required class="w-full px-3 py-2 rounded-lg text-sm bg-gray-50 border border-gray-200">
                                <!-- Populated dynamically -->
                            </select>
                        </div>
                    </div>

                    <!-- Client Auto-suggest -->
                    <div class="relative">
                        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase">Client Name</label>
                        <input type="text" id="qa-client-name" autocomplete="off" placeholder="Start typing..." required class="w-full px-3 py-2 rounded-lg text-sm bg-gray-50 border border-gray-200 focus:border-gray-900">
                        <!-- Dropdown -->
                        <div id="qa-client-suggestions" class="absolute z-10 w-full bg-white border border-gray-200 mt-1 rounded-lg shadow-xl hidden max-h-40 overflow-y-auto"></div>
                        <input type="hidden" id="qa-client-id">
                    </div>

                    <!-- Tags -->
                    <div class="flex gap-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="qa-is-new" class="accent-gray-900 w-4 h-4 rounded">
                            <span class="text-sm font-medium text-gray-700">First Time Client</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="qa-is-rebooked" class="accent-gray-900 w-4 h-4 rounded" checked>
                            <span class="text-sm font-medium text-gray-700">Rebooked Next Visit</span>
                        </label>
                    </div>

                    <!-- Treatments / Revenue -->
                    <div class="space-y-3 pt-4 border-t border-gray-200">
                        <label class="block text-sm font-bold text-gray-900">Services Performed</label>
                        
                        <div id="qa-services-container" class="space-y-3">
                            <!-- Dynamic Service Rows Injected Here -->
                        </div>
                        
                        <button type="button" onclick="addQaServiceRow()" class="text-xs text-gray-600 font-medium hover:text-gray-900 flex items-center gap-1 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            Add another service
                        </button>
                        
                        <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-100">
                            <label class="block text-xs font-semibold text-gray-600 uppercase">Total Services ($)</label>
                            <span id="qa-services-total-display" class="text-lg font-bold text-gray-900">$0.00</span>
                            <input type="hidden" id="qa-services-amount" value="0">
                        </div>

                        <div class="pt-4 border-t border-gray-100">
                            <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase">Retail Products ($)</label>
                            <input type="number" id="qa-retail-amount" min="0" step="0.01" value="0" class="w-full px-3 py-2 rounded-lg text-lg font-bold bg-gray-50 border border-gray-200 focus:border-gray-900">
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full bg-gray-900 text-white shadow-md py-3 rounded-xl font-medium mt-4 hover:bg-gray-800 transition-colors">Save Sale</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Client Details Modal -->
    <div id="modal-client" class="fixed inset-0 bg-gray-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white border border-gray-200 shadow-2xl rounded-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg text-gray-900" id="client-modal-title">Client Profile</h3>
                <button onclick="closeModal('modal-client')" class="text-gray-400 hover:text-gray-900">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <form id="form-client" onsubmit="submitClient(event)" class="space-y-6">
                    <input type="hidden" id="client-id">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase">Full Name</label>
                            <input type="text" id="client-name" required class="w-full px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 focus:border-gray-900">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase">Phone</label>
                            <input type="tel" id="client-phone" class="w-full px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 focus:border-gray-900">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase">Email</label>
                            <input type="email" id="client-email" class="w-full px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 focus:border-gray-900">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs text-gray-900 mb-1 font-bold uppercase">Clinical Notes & Preferences</label>
                        <textarea id="client-notes" rows="4" class="w-full px-3 py-2 rounded-lg resize-none bg-gray-50 border border-gray-200 focus:border-gray-900" placeholder="Allergies, preferred pressure, usual treatments..."></textarea>
                    </div>

                    <div id="client-history-section" class="hidden border-t border-gray-200 pt-4 mt-4">
                        <h4 class="text-sm font-bold mb-3 text-gray-900">Recent Visits</h4>
                        <div class="bg-gray-50 rounded-lg border border-gray-200 p-2 max-h-40 overflow-y-auto text-sm" id="client-history-list">
                            <!-- Populated JS -->
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                        <button type="button" onclick="closeModal('modal-client')" class="px-4 py-2 rounded-lg bg-white border border-gray-200 text-gray-700 font-medium hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-gray-900 shadow-md text-white font-medium hover:bg-gray-800">Save Profile</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Staff Details Modal -->
    <div id="modal-staff" class="fixed inset-0 bg-gray-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white border border-gray-200 shadow-2xl rounded-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg text-gray-900" id="staff-modal-title">Staff Profile</h3>
                <button onclick="closeModal('modal-staff')" class="text-gray-400 hover:text-gray-900">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <form id="form-staff" onsubmit="submitStaff(event)" class="space-y-5">
                    <input type="hidden" id="staff-id">
                    
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase">Full Name</label>
                        <input type="text" id="staff-name" required class="w-full px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 focus:border-gray-900">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase">Email Address</label>
                            <input type="email" id="staff-email" required class="w-full px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 focus:border-gray-900">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase">Login PIN</label>
                            <input type="text" id="staff-pin" required class="w-full px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 focus:border-gray-900">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase">Hourly Salary ($)</label>
                            <input type="number" id="staff-hourly" min="0" step="0.01" required class="w-full px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 focus:border-gray-900">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase">Hours per Week</label>
                            <input type="number" id="staff-hours" min="0" step="0.5" required class="w-full px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 focus:border-gray-900">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase">Role</label>
                        <select id="staff-role" class="w-full px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 focus:border-gray-900">
                            <option value="Therapist">Therapist</option>
                            <option value="Manager">Manager</option>
                        </select>
                    </div>
                    
                    <div class="flex justify-between items-center pt-4 border-t border-gray-200 mt-4">
                        <button type="button" id="btn-delete-staff" onclick="deleteStaff()" class="text-sm text-red-600 hover:text-red-800 font-medium hidden">Delete Staff</button>
                        <div class="flex gap-3 ml-auto">
                            <button type="button" onclick="closeModal('modal-staff')" class="px-4 py-2 rounded-lg bg-white border border-gray-200 text-gray-700 font-medium hover:bg-gray-50">Cancel</button>
                            <button type="submit" class="px-4 py-2 rounded-lg bg-gray-900 shadow-md text-white font-medium hover:bg-gray-800">Save Staff</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        // ----------------------------------------------------------------------
        // 1. Firebase Imports & Initialization (Following strict Canvas Rules)
        // ----------------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your actual Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAmh-KQgj2ZZEkBhxrKnt1LhAI1kUeQtPE",
            authDomain: "trb-tracker.firebaseapp.com",
            projectId: "trb-tracker",
            storageBucket: "trb-tracker.firebasestorage.app",
            messagingSenderId: "247021190025",
            appId: "1:247021190025:web:fb3545aa3ef75841afff58"
        };
        
        // Fixed app ID for your Firestore database paths
        const appId = 'trb-tracker-production';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ----------------------------------------------------------------------
        // 2. Global State & DOM Elements
        // ----------------------------------------------------------------------
        const STATE = {
            firebaseUser: null, // The underlying Canvas auth user
            appUser: null,      // The active Clinic Staff member (Manager/Therapist)
            staff: [],
            clients: [],
            sales: [],
            appointments: [],
            services: [],
            charts: {
                goal: null,
                breakdown: null,
                team: null,
                groupGoal: null
            },
            unsubs: [] // Array of firestore unsubscribe functions
        };

        // Navigation Config
        const NAV_ITEMS = [
            { id: 'me', label: 'Me', icon: '<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>' },
            { id: 'history', label: 'History', icon: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline>' },
            { id: 'clients', label: 'Clients', icon: '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path>' },
            { id: 'group', label: 'Group', icon: '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line>' },
            { id: 'setup', label: 'Setup', icon: '<circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>' }
        ];

        // ----------------------------------------------------------------------
        // 3. Auth & Initialization Flow
        // ----------------------------------------------------------------------
        
        async function initApp() {
            try {
                // 1. Authenticate with custom external Firebase using Anonymous Auth
                await signInAnonymously(auth);
                
                // 2. Setup Auth Listener
                onAuthStateChanged(auth, async (user) => {
                    STATE.firebaseUser = user;
                    if (user) {
                        // 3. Load Base Data needed for login (Staff List)
                        await loadStaffOnce();
                    } else {
                        showLoginScreen();
                    }
                });
            } catch (err) {
                console.error("Auth Init Error:", err);
                showToast("Connection failed. Retrying...", "error");
            }
        }

        // Fetch staff initially to determine if we show "Setup" or "Login"
        async function loadStaffOnce() {
            const staffRef = collection(db, 'artifacts', appId, 'public', 'data', 'staff');
            onSnapshot(staffRef, (snapshot) => {
                STATE.staff = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // If we haven't logged into the app layer yet, handle the login UI
                if (!STATE.appUser) {
                    document.getElementById('loading-overlay').classList.add('hidden');
                    
                    if (STATE.staff.length === 0) {
                        // First time setup
                        document.getElementById('setup-notice').classList.remove('hidden');
                        document.getElementById('login-name-field').classList.remove('hidden');
                        document.getElementById('login-btn').innerText = "Create Master Account";
                    } else {
                        // Normal login
                        document.getElementById('setup-notice').classList.add('hidden');
                        document.getElementById('login-name-field').classList.add('hidden');
                        document.getElementById('login-btn').innerText = "Access Dashboard";
                    }
                } else {
                    // Update UI if staff changes while logged in
                    if(STATE.appUser.role === 'Manager') renderSetupSection();
                }
            }, (error) => {
                console.error("Firestore read error:", error);
                showToast("Database access denied.", "error");
            });
        }

        // App-level Login Handler (Simulated secure login within the public environment)
        window.handleLogin = async function(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim();
            const pin = document.getElementById('login-pin').value;
            const isSetup = STATE.staff.length === 0;

            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                if (isSetup) {
                    const name = document.getElementById('login-name').value.trim();
                    // Create first manager
                    const newStaff = {
                        name: name,
                        email: email,
                        pin: pin, // In a real app, hash this!
                        role: 'Manager',
                        target: 5000,
                        createdAt: new Date().toISOString()
                    };
                    const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'staff'), newStaff);
                    STATE.appUser = { id: docRef.id, ...newStaff };
                } else {
                    // Find user
                    const user = STATE.staff.find(s => s.email.toLowerCase() === email.toLowerCase() && s.pin === pin);
                    if (user) {
                        STATE.appUser = user;
                    } else {
                        throw new Error("Invalid email or PIN.");
                    }
                }
                
                // Login Success
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('app-wrapper').classList.remove('hidden');
                
                initializeAuthenticatedSession();

            } catch (err) {
                showToast(err.message, "error");
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };

        window.logoutApp = function() {
            STATE.appUser = null;
            // Clear listeners
            STATE.unsubs.forEach(unsub => unsub());
            STATE.unsubs = [];
            
            document.getElementById('app-wrapper').classList.add('hidden');
            document.getElementById('login-overlay').classList.remove('hidden');
            document.getElementById('login-pin').value = '';
        }

        // ----------------------------------------------------------------------
        // 4. Data Subscriptions (Firestore -> State)
        // ----------------------------------------------------------------------
        function initializeAuthenticatedSession() {
            if (!STATE.firebaseUser || !STATE.appUser) return;

            // Setup Navigation
            buildNavigation();
            updateUserProfileUI();

            // Setup Realtime Listeners (No complex queries as per Canvas Rules)
            const publicPath = `artifacts/${appId}/public/data`;
            
            // 1. Clients
            const u1 = onSnapshot(collection(db, publicPath, 'clients'), (snap) => {
                STATE.clients = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderClientsList();
            }, err => console.error(err));
            
            // 2. Sales
            const u2 = onSnapshot(collection(db, publicPath, 'sales'), (snap) => {
                STATE.sales = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderDashboard();
                renderHistory();
                renderGroup();
            }, err => console.error(err));

            // 3. Appointments
            const u3 = onSnapshot(collection(db, publicPath, 'appointments'), (snap) => {
                STATE.appointments = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderDashboard();
            }, err => console.error(err));

            // 4. Services
            const u4 = onSnapshot(collection(db, publicPath, 'services'), (snap) => {
                STATE.services = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(STATE.appUser.role === 'Manager') renderSetupSection();
            }, err => console.error(err));

            STATE.unsubs.push(u1, u2, u3, u4);

            // Set Initial Section
            switchSection('me');
            
            showToast(`Welcome back, ${STATE.appUser.name.split(' ')[0]}!`);
        }

        // ----------------------------------------------------------------------
        // 5. UI Layout & Navigation
        // ----------------------------------------------------------------------
        function buildNavigation() {
            const nav = document.getElementById('bottom-nav');
            nav.innerHTML = '';

            NAV_ITEMS.forEach(item => {
                // Hide setup for non-managers
                if (item.id === 'setup' && STATE.appUser.role !== 'Manager') return;

                const btn = document.createElement('button');
                btn.className = `flex flex-col items-center p-2 min-w-[72px] rounded-xl transition-all nav-btn ${item.id === 'me' ? 'text-gray-900 font-bold bg-gray-100 shadow-sm' : 'text-gray-500 hover:bg-gray-50 hover:text-gray-900'}`;
                btn.onclick = () => switchSection(item.id);
                btn.dataset.target = item.id;
                btn.innerHTML = `<svg class="nav-icon w-6 h-6 mb-1" viewBox="0 0 24 24">${item.icon}</svg> <span class="text-[10px] md:text-xs">${item.label}</span>`;
                nav.appendChild(btn);
            });
        }

        function updateUserProfileUI() {
            // Because we removed the sidebar, we safely check for these elements first
            const nameEl = document.getElementById('user-name-display');
            if (nameEl) nameEl.innerText = STATE.appUser.name;
            const roleEl = document.getElementById('user-role-display');
            if (roleEl) roleEl.innerText = STATE.appUser.role;
            const avatarEl = document.getElementById('user-avatar');
            if (avatarEl) avatarEl.innerText = STATE.appUser.name.charAt(0).toUpperCase();
            
            document.getElementById('dash-name').innerText = STATE.appUser.name.split(' ')[0];
            
            // Populate Quick Add Staff dropdown
            const staffSelect = document.getElementById('qa-staff');
            staffSelect.innerHTML = STATE.staff.map(s => 
                `<option value="${s.id}" ${s.id === STATE.appUser.id ? 'selected' : ''}>${s.name}</option>`
            ).join('');
        }

        window.switchSection = function(sectionId) {
            // Update UI State
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${sectionId}`).classList.remove('hidden');
            
            // Update Nav Active States
            document.querySelectorAll('.nav-btn').forEach(b => {
                if(b.dataset.target === sectionId) b.className = 'flex flex-col items-center p-2 min-w-[72px] rounded-xl transition-all nav-btn text-gray-900 font-bold bg-gray-100 shadow-sm';
                else b.className = 'flex flex-col items-center p-2 min-w-[72px] rounded-xl transition-all nav-btn text-gray-500 hover:bg-gray-50 hover:text-gray-900';
            });

            // Update Header Title
            const item = NAV_ITEMS.find(i => i.id === sectionId);
            const titleEl = document.getElementById('page-title');
            if(titleEl) titleEl.innerText = item ? item.label : 'Dashboard';

            // Trigger Specific Renderers
            if(sectionId === 'me') renderDashboard();
            if(sectionId === 'history') renderHistoryFilters();
            if(sectionId === 'group') renderGroup();
        }

        // ----------------------------------------------------------------------
        // 6. Section Renderers & Business Logic
        // ----------------------------------------------------------------------

        // Helper: Date formatting
        const getMonthId = (dateObj) => `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
        const formatCurrency = (num) => '$' + Number(num).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

        // --- SECTION: ME (Dashboard) ---
        function renderDashboard() {
            if(!STATE.appUser) return;
            const now = new Date();
            const currentMonthId = getMonthId(now);
            const todayStr = now.toISOString().split('T')[0];
            
            document.getElementById('current-month-label').innerText = now.toLocaleString('default', { month: 'long', year: 'numeric' });
            document.getElementById('today-date-badge').innerText = now.toLocaleDateString('default', { weekday: 'short', month: 'short', day: 'numeric' });

            // Calculate Stats for Current User & Month
            let totalRevenue = 0, totalServices = 0, totalRetail = 0;
            let rebookCount = 0, totalSalesCount = 0;

            const myMonthlySales = STATE.sales.filter(s => 
                s.staffId === STATE.appUser.id && s.date.startsWith(currentMonthId)
            );

            myMonthlySales.forEach(sale => {
                totalServices += Number(sale.servicesAmount || 0);
                totalRetail += Number(sale.retailAmount || 0);
                totalRevenue += (Number(sale.servicesAmount || 0) + Number(sale.retailAmount || 0));
                totalSalesCount++;
                if(sale.isRebooked) rebookCount++;
            });

            document.getElementById('stat-revenue').innerText = formatCurrency(totalRevenue);
            document.getElementById('stat-services').innerText = formatCurrency(totalServices);
            document.getElementById('stat-retail').innerText = formatCurrency(totalRetail);
            
            const rebookRate = totalSalesCount > 0 ? Math.round((rebookCount / totalSalesCount) * 100) : 0;
            document.getElementById('stat-rebook').innerText = `${rebookRate}%`;

            // Render Charts
            renderMyCharts(totalRevenue, totalServices, totalRetail);

            // Render Today's Appointments
            const myTodayAppts = STATE.appointments.filter(a => a.date === todayStr && a.staffId === STATE.appUser.id);
            // Sort by time
            myTodayAppts.sort((a, b) => a.time.localeCompare(b.time));
            
            const apptList = document.getElementById('appointments-list');
            if (myTodayAppts.length === 0) {
                apptList.innerHTML = `<p class="text-sm text-gray-400 text-center py-4">No appointments scheduled for today.</p>`;
            } else {
                apptList.innerHTML = myTodayAppts.map(appt => `
                    <div class="bg-white border border-gray-200 shadow-sm p-3 rounded-xl flex items-center justify-between group">
                        <div class="flex items-center gap-3">
                            <div class="bg-gray-100 text-gray-700 font-medium px-2 py-1 rounded text-xs whitespace-nowrap">${appt.time}</div>
                            <div>
                                <p class="font-medium text-sm text-gray-900">${appt.clientName}</p>
                                <p class="text-xs text-gray-500 truncate w-32 md:w-48">${appt.service || 'Appointment'}</p>
                            </div>
                        </div>
                        <button onclick="deleteAppointment('${appt.id}')" class="text-gray-400 hover:text-red-500 transition opacity-0 group-hover:opacity-100 p-1">&times;</button>
                    </div>
                `).join('');
            }
        }

        function renderMyCharts(totalRev, servicesRev, retailRev) {
            Chart.defaults.color = '#6b7280';
            Chart.defaults.font.family = 'Inter';

            const target = Number(STATE.appUser.target || 0);
            const remaining = Math.max(0, target - totalRev);
            
            // Update Text Labels
            document.getElementById('me-goal-target').innerText = formatCurrency(target);
            document.getElementById('me-goal-achieved').innerText = formatCurrency(totalRev);
            document.getElementById('me-goal-remaining').innerText = formatCurrency(remaining);
            
            // Chart 1: Goal Doughnut
            const ctx1 = document.getElementById('goalChart').getContext('2d');
            if(STATE.charts.goal) STATE.charts.goal.destroy();
            STATE.charts.goal = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Achieved', 'Remaining'],
                    datasets: [{
                        data: [totalRev, remaining],
                        backgroundColor: ['#111827', '#f3f4f6'],
                        borderWidth: 0,
                        cutout: '75%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: { callbacks: { label: (c) => ` $${c.raw.toLocaleString()}` } }
                    }
                },
                plugins: [{
                    id: 'textCenter',
                    beforeDraw: function(chart) {
                        var width = chart.width, height = chart.height, ctx = chart.ctx;
                        ctx.restore();
                        var fontSize = (height / 114).toFixed(2);
                        ctx.font = "bold " + fontSize + "em Inter";
                        ctx.textBaseline = "middle";
                        ctx.fillStyle = "#111827";
                        var percent = target > 0 ? Math.round((totalRev/target)*100) : 0;
                        var text = percent + "%", textX = Math.round((width - ctx.measureText(text).width) / 2), textY = height / 2;
                        ctx.fillText(text, textX, textY);
                        ctx.save();
                    }
                }]
            });

            // Chart 2: Breakdown Bar
            const ctx2 = document.getElementById('breakdownChart').getContext('2d');
            if(STATE.charts.breakdown) STATE.charts.breakdown.destroy();
            STATE.charts.breakdown = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Services', 'Retail'],
                    datasets: [{
                        label: 'Revenue',
                        data: [servicesRev, retailRev],
                        backgroundColor: ['#111827', '#cbd5e1'],
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false, grid: { display: false } },
                        x: { grid: { display: false }, border: { display: false } }
                    }
                }
            });
        }

        // --- SECTION: HISTORY ---
        function renderHistoryFilters() {
            // Populate Month Dropdown based on existing sales
            const select = document.getElementById('history-month-filter');
            const months = new Set(STATE.sales.map(s => s.date.substring(0, 7))); // YYYY-MM
            
            // Ensure current month is always there
            const current = getMonthId(new Date());
            months.add(current);

            const sortedMonths = Array.from(months).sort().reverse();
            select.innerHTML = sortedMonths.map(m => {
                const [y, mo] = m.split('-');
                const label = new Date(y, mo-1).toLocaleString('default', { month: 'short', year: 'numeric' });
                return `<option value="${m}" ${m === current ? 'selected' : ''}>${label}</option>`;
            }).join('');
            
            renderHistory();
        }

        window.renderHistory = function() {
            const monthFilter = document.getElementById('history-month-filter').value;
            const tbody = document.getElementById('history-table-body');
            
            // Filter: Manager sees all, Therapist sees own
            let filtered = STATE.sales.filter(s => s.date.startsWith(monthFilter));
            if(STATE.appUser.role !== 'Manager') {
                filtered = filtered.filter(s => s.staffId === STATE.appUser.id);
            }
            
            // Sort newest first
            filtered.sort((a, b) => b.date.localeCompare(a.date));

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-8 text-center text-gray-400">No sales recorded for this period.</td></tr>`;
                return;
            }

            tbody.innerHTML = filtered.map(sale => {
                const staff = STATE.staff.find(s => s.id === sale.staffId)?.name || 'Unknown';
                const client = STATE.clients.find(c => c.id === sale.clientId)?.name || 'Unknown';
                const total = Number(sale.servicesAmount || 0) + Number(sale.retailAmount || 0);
                
                let tags = '';
                if(sale.isNewClient) tags += `<span class="bg-gray-100 text-gray-700 text-[10px] px-2 py-0.5 rounded mr-1 font-medium border border-gray-200">New</span>`;
                if(sale.isRebooked) tags += `<span class="bg-green-50 text-green-700 text-[10px] px-2 py-0.5 rounded font-medium border border-green-200">Rebooked</span>`;

                return `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4 text-gray-600">${sale.date}</td>
                        <td class="px-6 py-4 font-medium text-gray-900">${client}</td>
                        <td class="px-6 py-4 text-gray-500">${staff.split(' ')[0]}</td>
                        <td class="px-6 py-4 text-gray-500">${formatCurrency(sale.servicesAmount)}</td>
                        <td class="px-6 py-4 text-gray-500">${formatCurrency(sale.retailAmount)}</td>
                        <td class="px-6 py-4 font-bold text-gray-900 text-right">${formatCurrency(total)}</td>
                        <td class="px-6 py-4 text-center">${tags}</td>
                    </tr>
                `;
            }).join('');
        }

        // --- SECTION: CLIENTS ---
        window.renderClientsList = function() {
            const query = document.getElementById('client-search').value.toLowerCase();
            const grid = document.getElementById('clients-grid');
            
            let filtered = STATE.clients;
            if(query) {
                filtered = filtered.filter(c => 
                    (c.name && c.name.toLowerCase().includes(query)) || 
                    (c.phone && c.phone.includes(query))
                );
            }
            
            // Sort alphabetical
            filtered.sort((a,b) => (a.name || '').localeCompare(b.name || ''));

            if(filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-10 text-gray-400">No clients found.</div>`;
                return;
            }

            grid.innerHTML = filtered.map(client => `
                <div onclick="openClientModal('${client.id}')" class="bg-white border border-gray-200 shadow-sm p-4 rounded-xl hover:border-gray-400 cursor-pointer transition flex items-center gap-4 group">
                    <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center font-bold text-gray-500 group-hover:bg-gray-200 group-hover:text-gray-900 transition">
                        ${client.name ? client.name.charAt(0).toUpperCase() : '?'}
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <h4 class="font-bold truncate text-gray-900">${client.name}</h4>
                        <p class="text-xs text-gray-500 truncate">${client.phone || 'No phone'}</p>
                    </div>
                </div>
            `).join('');
        }

        // --- SECTION: GROUP ---
        window.renderGroup = function() {
            if(!STATE.appUser) return;
            
            // Calculate Start and End of Current Week (Monday - Sunday)
            const now = new Date();
            const day = now.getDay();
            const diff = now.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
            
            const startOfWeek = new Date(now.setDate(diff));
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
            
            // Aggregate Data
            const staffPerformance = {};
            let teamTarget = 0;
            STATE.staff.forEach(s => {
                // Use the weekly target set in their profile
                const sTarget = Number(s.target||0);
                teamTarget += sTarget;
                staffPerformance[s.id] = { name: s.name.split(' ')[0], total: 0, target: sTarget };
            });

            const treatmentCounts = {};
            let teamTotalRev = 0, teamServicesRev = 0, teamRetailRev = 0, teamRebookCount = 0, teamSalesCount = 0;

            // Filter sales to just this week
            const weeklySales = STATE.sales.filter(s => {
                const saleDate = new Date(s.date);
                return saleDate >= startOfWeek && saleDate <= endOfWeek;
            });

            weeklySales.forEach(sale => {
                const srvAmt = Number(sale.servicesAmount||0);
                const retAmt = Number(sale.retailAmount||0);
                const totalAmt = srvAmt + retAmt;

                if(staffPerformance[sale.staffId]) {
                    staffPerformance[sale.staffId].total += totalAmt;
                }
                if(sale.treatments) {
                    const treats = sale.treatments.split(',').map(t => t.trim()).filter(t => t);
                    treats.forEach(t => {
                        treatmentCounts[t] = (treatmentCounts[t] || 0) + 1;
                    });
                }

                // Accumulate team totals
                teamServicesRev += srvAmt;
                teamRetailRev += retAmt;
                teamTotalRev += totalAmt;
                teamSalesCount++;
                if(sale.isRebooked) teamRebookCount++;
            });

            // Update DOM Group Stats
            document.getElementById('group-stat-revenue').innerText = formatCurrency(teamTotalRev);
            document.getElementById('group-stat-services').innerText = formatCurrency(teamServicesRev);
            document.getElementById('group-stat-retail').innerText = formatCurrency(teamRetailRev);
            const rebookRate = teamSalesCount > 0 ? Math.round((teamRebookCount / teamSalesCount) * 100) : 0;
            document.getElementById('group-stat-rebook').innerText = `${rebookRate}%`;

            const teamRemaining = Math.max(0, teamTarget - teamTotalRev);
            document.getElementById('group-goal-target').innerText = formatCurrency(teamTarget);
            document.getElementById('group-goal-achieved').innerText = formatCurrency(teamTotalRev);
            document.getElementById('group-goal-remaining').innerText = formatCurrency(teamRemaining);

            // Chart: Team Goal Doughnut
            const ctxGroupGoal = document.getElementById('groupGoalChart').getContext('2d');
            if(STATE.charts.groupGoal) STATE.charts.groupGoal.destroy();
            STATE.charts.groupGoal = new Chart(ctxGroupGoal, {
                type: 'doughnut',
                data: {
                    labels: ['Achieved', 'Remaining'],
                    datasets: [{
                        data: [teamTotalRev, teamRemaining],
                        backgroundColor: ['#111827', '#e5e7eb'],
                        borderWidth: 0,
                        cutout: '75%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: { callbacks: { label: (c) => ` $${c.raw.toLocaleString()}` } }
                    }
                },
                plugins: [{
                    id: 'textCenter',
                    beforeDraw: function(chart) {
                        var width = chart.width, height = chart.height, ctx = chart.ctx;
                        ctx.restore();
                        var fontSize = (height / 114).toFixed(2);
                        ctx.font = "bold " + fontSize + "em Inter";
                        ctx.textBaseline = "middle";
                        ctx.fillStyle = "#111827";
                        var percent = teamTarget > 0 ? Math.round((teamTotalRev/teamTarget)*100) : 0;
                        var text = percent + "%", textX = Math.round((width - ctx.measureText(text).width) / 2), textY = height / 2;
                        ctx.fillText(text, textX, textY);
                        ctx.save();
                    }
                }]
            });

            // Chart: Team Leaderboard
            const ctx = document.getElementById('teamChart').getContext('2d');
            if(STATE.charts.team) STATE.charts.team.destroy();
            
            const labels = [], dataAchieved = [], dataTarget = [];
            Object.values(staffPerformance).forEach(sp => {
                labels.push(sp.name);
                dataAchieved.push(sp.total);
                dataTarget.push(sp.target);
            });

            STATE.charts.team = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Actual Revenue',
                            data: dataAchieved,
                            backgroundColor: '#111827',
                            borderRadius: 4
                        },
                        {
                            label: 'Weekly Target',
                            data: dataTarget,
                            backgroundColor: '#e5e7eb',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            display: true, 
                            position: 'top', 
                            align: 'end',
                            labels: { boxWidth: 12, usePointStyle: true }
                        },
                        tooltip: { callbacks: { label: (c) => ` ${c.dataset.label}: $${c.raw.toLocaleString()}` } }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            grid: { color: '#f3f4f6' },
                            ticks: { callback: (val) => '$'+val }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });

            // List: Top Treatments
            const topTreatments = Object.entries(treatmentCounts)
                .sort((a,b) => b[1] - a[1])
                .slice(0, 5);
            
            const treatList = document.getElementById('top-treatments-list');
            if(topTreatments.length === 0) {
                treatList.innerHTML = `<p class="text-sm text-gray-400">Not enough data this week.</p>`;
            } else {
                treatList.innerHTML = topTreatments.map(([name, count], index) => `
                    <div class="flex items-center justify-between p-3 bg-white shadow-sm rounded-xl border border-gray-100">
                        <div class="flex items-center gap-3">
                            <span class="text-gray-400 font-bold text-sm w-4">${index+1}.</span>
                            <span class="text-sm font-medium text-gray-900">${name}</span>
                        </div>
                        <span class="text-xs bg-gray-50 border border-gray-200 px-2 py-1 rounded text-gray-600 font-medium">${count} logged</span>
                    </div>
                `).join('');
            }
        }

        // --- SECTION: SETUP ---
        window.renderSetupSection = function() {
            if(STATE.appUser?.role !== 'Manager') return;

            // Staff List
            const slist = document.getElementById('setup-staff-list');
            slist.innerHTML = STATE.staff.map(s => `
                <div onclick="openStaffModal('${s.id}')" class="flex items-center justify-between p-3 bg-white shadow-sm rounded-xl border border-gray-100 cursor-pointer hover:border-gray-400 transition group">
                    <div>
                        <p class="font-medium text-sm text-gray-900">${s.name} <span class="text-xs bg-gray-100 border border-gray-200 text-gray-600 font-medium px-1.5 py-0.5 rounded ml-1">${s.role}</span></p>
                        <p class="text-xs text-gray-500 mt-0.5">${s.email} | Target: ${formatCurrency(s.target || 0)}</p>
                    </div>
                    <svg class="w-5 h-5 text-gray-300 group-hover:text-gray-600 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </div>
            `).join('');

            // Services List
            const srvlist = document.getElementById('setup-services-list');
            if(STATE.services.length === 0) {
                srvlist.innerHTML = `<p class="text-xs text-gray-400">No services added.</p>`;
            } else {
                srvlist.innerHTML = STATE.services.map(s => `
                    <div class="flex items-center justify-between p-2 border-b border-gray-100 last:border-0">
                        <span class="text-sm text-gray-600 font-medium">${s.name}</span>
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-bold text-gray-900">${formatCurrency(s.price)}</span>
                            <button onclick="deleteService('${s.id}')" class="text-gray-400 hover:text-red-500 text-lg">&times;</button>
                        </div>
                    </div>
                `).join('');
            }
        }


        // ----------------------------------------------------------------------
        // 7. Modals & Data Entry (CRUD)
        // ----------------------------------------------------------------------

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // --- Quick Add Sale ---
        window.openQuickAddModal = function() {
            document.getElementById('form-quick-add').reset();
            document.getElementById('qa-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('qa-staff').value = STATE.appUser.id;
            document.getElementById('qa-client-id').value = '';
            document.getElementById('qa-client-suggestions').classList.add('hidden');
            
            // Initialize dynamic service rows
            document.getElementById('qa-services-container').innerHTML = '';
            addQaServiceRow();
            calculateQaTotal();
            
            document.getElementById('modal-quick-add').classList.remove('hidden');
        }

        window.addQaServiceRow = function() {
            const container = document.getElementById('qa-services-container');
            const row = document.createElement('div');
            row.className = 'flex gap-2 items-start qa-service-row';
            
            // Generate options based on setup services
            const serviceOptions = STATE.services.map(s => 
                `<option value="${s.id}" data-name="${s.name}" data-price="${s.price}">${s.name} ($${s.price})</option>`
            ).join('');
            
            row.innerHTML = `
                <div class="flex-1">
                    <select class="w-full px-3 py-2 rounded-lg text-sm bg-gray-50 border border-gray-200 focus:border-gray-900 qa-service-select" onchange="handleQaServiceChange(this)">
                        <option value="">-- Select Service --</option>
                        ${serviceOptions}
                        <option value="custom" class="font-medium text-gray-600">Custom Service...</option>
                    </select>
                    <input type="text" placeholder="Enter custom service name" class="w-full mt-2 px-3 py-2 rounded-lg text-sm bg-white border border-gray-300 focus:border-gray-900 hidden qa-custom-name">
                </div>
                <div class="w-24">
                    <input type="number" min="0" step="0.01" placeholder="Price" class="w-full px-3 py-2 rounded-lg text-sm bg-gray-50 border border-gray-200 focus:border-gray-900 qa-service-price" oninput="calculateQaTotal()">
                </div>
                <button type="button" class="text-gray-400 hover:text-red-500 p-2" onclick="removeQaServiceRow(this)" title="Remove service">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            `;
            container.appendChild(row);
        }

        window.handleQaServiceChange = function(selectEl) {
            const row = selectEl.closest('.qa-service-row');
            const priceInput = row.querySelector('.qa-service-price');
            const customNameInput = row.querySelector('.qa-custom-name');
            
            if (selectEl.value === 'custom') {
                customNameInput.classList.remove('hidden');
                priceInput.value = '';
                priceInput.focus();
            } else if (selectEl.value !== '') {
                customNameInput.classList.add('hidden');
                const selectedOption = selectEl.options[selectEl.selectedIndex];
                priceInput.value = selectedOption.dataset.price;
            } else {
                customNameInput.classList.add('hidden');
                priceInput.value = '';
            }
            calculateQaTotal();
        }

        window.removeQaServiceRow = function(btn) {
            btn.closest('.qa-service-row').remove();
            calculateQaTotal();
        }

        window.calculateQaTotal = function() {
            let total = 0;
            document.querySelectorAll('.qa-service-price').forEach(input => {
                total += Number(input.value) || 0;
            });
            document.getElementById('qa-services-total-display').innerText = formatCurrency(total);
            document.getElementById('qa-services-amount').value = total;
        }

        // Client Auto-suggest Logic for Quick Add
        const qaClientInput = document.getElementById('qa-client-name');
        const qaSuggestDiv = document.getElementById('qa-client-suggestions');
        
        qaClientInput.addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            if(!val) {
                qaSuggestDiv.classList.add('hidden');
                document.getElementById('qa-client-id').value = '';
                return;
            }
            
            const matches = STATE.clients.filter(c => c.name.toLowerCase().includes(val));
            if(matches.length > 0) {
                qaSuggestDiv.innerHTML = matches.map(c => `
                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm border-b border-gray-100 last:border-0 text-gray-900 font-medium" 
                         onclick="selectQaClient('${c.id}', '${c.name.replace(/'/g, "\\'")}')">
                        ${c.name} <span class="text-xs text-gray-400 font-normal ml-1">${c.phone||''}</span>
                    </div>
                `).join('');
                qaSuggestDiv.classList.remove('hidden');
            } else {
                qaSuggestDiv.innerHTML = `<div class="px-3 py-2 text-xs text-gray-500 italic">New client will be created</div>`;
                qaSuggestDiv.classList.remove('hidden');
                document.getElementById('qa-client-id').value = '';
            }
        });

        window.selectQaClient = function(id, name) {
            document.getElementById('qa-client-id').value = id;
            qaClientInput.value = name;
            qaSuggestDiv.classList.add('hidden');
        }

        // Hide suggestions on click outside
        document.addEventListener('click', (e) => {
            if(!qaClientInput.contains(e.target) && !qaSuggestDiv.contains(e.target)) {
                qaSuggestDiv.classList.add('hidden');
            }
        });

        window.submitQuickAdd = async function(e) {
            e.preventDefault();

            // Validate Services & Build Treatments List
            let treatments = [];
            let hasZeroPrice = false;

            document.querySelectorAll('.qa-service-row').forEach(row => {
                const select = row.querySelector('.qa-service-select');
                const priceInput = row.querySelector('.qa-service-price');
                const customInput = row.querySelector('.qa-custom-name');
                
                let name = '';
                if(select.value === 'custom') name = customInput.value.trim() || 'Custom Service';
                else if(select.value !== '') name = select.options[select.selectedIndex].dataset.name;

                const price = Number(priceInput.value) || 0;

                if (name || price > 0) { // Only process rows that have a service selected OR a price entered
                    if (price <= 0) hasZeroPrice = true;
                    treatments.push(name || 'Unnamed Service');
                }
            });

            if (hasZeroPrice) {
                showToast("Service prices must be greater than $0.", "error");
                return;
            }

            const servicesAmount = Number(document.getElementById('qa-services-amount').value);
            const retailAmount = Number(document.getElementById('qa-retail-amount').value);

            if (servicesAmount === 0 && retailAmount === 0) {
                 showToast("Please add at least one service or retail amount.", "error");
                 return;
            }

            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerText = 'Saving...';

            try {
                let clientId = document.getElementById('qa-client-id').value;
                const clientName = document.getElementById('qa-client-name').value.trim();

                // 1. Create client if new
                if (!clientId) {
                    const newClient = { name: clientName, createdAt: new Date().toISOString() };
                    const cRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'clients'), newClient);
                    clientId = cRef.id;
                }

                // 2. Create Sale Record
                const saleData = {
                    date: document.getElementById('qa-date').value,
                    staffId: document.getElementById('qa-staff').value,
                    clientId: clientId,
                    servicesAmount: servicesAmount,
                    retailAmount: retailAmount,
                    treatments: treatments.join(', '),
                    isNewClient: document.getElementById('qa-is-new').checked,
                    isRebooked: document.getElementById('qa-is-rebooked').checked,
                    createdAt: new Date().toISOString()
                };

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'sales'), saleData);
                
                showToast("Sale logged successfully!");
                closeModal('modal-quick-add');
            } catch (err) {
                console.error(err);
                showToast("Error saving sale.", "error");
            } finally {
                btn.disabled = false;
                btn.innerText = 'Save Sale';
            }
        }

        // --- Client Profile Modal ---
        window.openClientModal = function(clientId) {
            const form = document.getElementById('form-client');
            form.reset();
            const histSec = document.getElementById('client-history-section');
            const histList = document.getElementById('client-history-list');
            
            if (clientId) {
                const client = STATE.clients.find(c => c.id === clientId);
                if(client) {
                    document.getElementById('client-modal-title').innerText = "Edit Client";
                    document.getElementById('client-id').value = client.id;
                    document.getElementById('client-name').value = client.name || '';
                    document.getElementById('client-phone').value = client.phone || '';
                    document.getElementById('client-email').value = client.email || '';
                    document.getElementById('client-notes').value = client.notes || '';
                    
                    // Show History
                    histSec.classList.remove('hidden');
                    const cSales = STATE.sales.filter(s => s.clientId === clientId).sort((a,b) => b.date.localeCompare(a.date));
                    if(cSales.length > 0) {
                        histList.innerHTML = cSales.map(s => {
                            const tot = Number(s.servicesAmount||0) + Number(s.retailAmount||0);
                            return `<div class="flex justify-between py-1.5 border-b border-gray-100 last:border-0">
                                <span class="text-gray-600 font-medium text-xs">${s.date} <span class="text-gray-400 ml-1 font-normal">(${s.treatments||'Retail'})</span></span>
                                <span class="font-bold text-gray-900">${formatCurrency(tot)}</span>
                            </div>`;
                        }).join('');
                    } else {
                        histList.innerHTML = `<span class="text-gray-400 italic">No past visits recorded.</span>`;
                    }
                }
            } else {
                document.getElementById('client-modal-title').innerText = "New Client";
                document.getElementById('client-id').value = '';
                histSec.classList.add('hidden');
            }
            document.getElementById('modal-client').classList.remove('hidden');
        }

        window.submitClient = async function(e) {
            e.preventDefault();
            const id = document.getElementById('client-id').value;
            const data = {
                name: document.getElementById('client-name').value.trim(),
                phone: document.getElementById('client-phone').value.trim(),
                email: document.getElementById('client-email').value.trim(),
                notes: document.getElementById('client-notes').value.trim(),
                updatedAt: new Date().toISOString()
            };

            try {
                if (id) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'clients', id), data);
                    showToast("Client updated!");
                } else {
                    data.createdAt = new Date().toISOString();
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'clients'), data);
                    showToast("New client added!");
                }
                closeModal('modal-client');
            } catch (err) {
                console.error(err);
                showToast("Error saving client.", "error");
            }
        }

        // --- Setup Actions (Manager) ---
        window.openStaffModal = function(staffId = null) {
            document.getElementById('form-staff').reset();
            if (staffId) {
                const s = STATE.staff.find(x => x.id === staffId);
                if(s) {
                    document.getElementById('staff-id').value = s.id;
                    document.getElementById('staff-name').value = s.name || '';
                    document.getElementById('staff-email').value = s.email || '';
                    document.getElementById('staff-pin').value = s.pin || '';
                    document.getElementById('staff-role').value = s.role || 'Therapist';
                    document.getElementById('staff-hourly').value = s.hourlyRate || 0;
                    document.getElementById('staff-hours').value = s.hoursPerWeek || 0;
                    document.getElementById('staff-modal-title').innerText = "Edit Staff";
                    document.getElementById('btn-delete-staff').classList.remove('hidden');
                }
            } else {
                document.getElementById('staff-id').value = '';
                document.getElementById('staff-role').value = 'Therapist';
                document.getElementById('staff-modal-title').innerText = "Add Staff";
                document.getElementById('btn-delete-staff').classList.add('hidden');
            }
            document.getElementById('modal-staff').classList.remove('hidden');
        }

        window.submitStaff = async function(e) {
            e.preventDefault();
            const id = document.getElementById('staff-id').value;
            const hourlyRate = Number(document.getElementById('staff-hourly').value);
            const hoursPerWeek = Number(document.getElementById('staff-hours').value);
            // Weekly target based on salary x hours worked x 4
            const target = hourlyRate * hoursPerWeek * 4;

            const data = {
                name: document.getElementById('staff-name').value.trim(),
                email: document.getElementById('staff-email').value.trim(),
                pin: document.getElementById('staff-pin').value.trim(),
                role: document.getElementById('staff-role').value,
                hourlyRate,
                hoursPerWeek,
                target,
                updatedAt: new Date().toISOString()
            };

            try {
                if (id) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'staff', id), data);
                    showToast("Staff updated!");
                } else {
                    data.createdAt = new Date().toISOString();
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'staff'), data);
                    showToast("Staff added!");
                }
                closeModal('modal-staff');
            } catch(err) { 
                showToast("Error saving staff", "error"); 
                console.error(err); 
            }
        }

        window.deleteStaff = async function() {
            const id = document.getElementById('staff-id').value;
            if(!id) return;
            
            if(confirm("Are you sure you want to remove this staff member?")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'staff', id));
                    showToast("Staff removed.");
                    closeModal('modal-staff');
                } catch(e) { showToast("Error removing staff", "error"); }
            }
        }

        window.openServiceModal = async function() {
            const name = prompt("Service Name (e.g., Deep Tissue Massage):");
            if(!name) return;
            const price = prompt("Price ($):");
            if(!price) return;

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'services'), {
                    name, price: Number(price)
                });
                showToast("Service added.");
            } catch(e) { showToast("Error adding service", "error"); }
        }

        window.deleteService = async function(id) {
            if(confirm("Delete this service?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'services', id));
            }
        }

        // --- Appointment Actions ---
        window.openAppointmentModal = async function() {
            const clientName = prompt("Client Name for Appointment:");
            if(!clientName) return;
            const time = prompt("Time (e.g., 10:00 AM):");
            if(!time) return;
            const service = prompt("Service:");

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'appointments'), {
                    date: new Date().toISOString().split('T')[0],
                    time,
                    clientName,
                    service,
                    staffId: STATE.appUser.id
                });
                showToast("Appointment added.");
            } catch(e) { showToast("Error adding appointment", "error"); }
        }

        window.deleteAppointment = async function(id) {
            if(confirm("Cancel this appointment?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'appointments', id));
            }
        }

        // ----------------------------------------------------------------------
        // 8. Utilities (Toasts)
        // ----------------------------------------------------------------------
        function showToast(message, type = "success") {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bg = type === 'error' ? 'bg-red-50 border-red-200 text-red-800' : 'bg-white border-gray-200 shadow-xl text-gray-900';
            toast.className = `${bg} border px-4 py-3 rounded-lg flex items-center gap-3 toast-enter text-sm font-medium`;
            
            toast.innerHTML = `
                ${type === 'success' ? '<svg class="w-5 h-5 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' : '<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>'}
                ${message}
            `;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(100%)';
                toast.style.transition = 'all 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Initialize!
        window.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

    </script>
</body>
</html>